<!DOCTYPE html>
<html lang="{{ lang }}" class="dark">
<head>
    <title>{{ _('ui.title') }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'photo-dark': '#0b0b0b',
                        'photo-card': '#151515',
                        'photo-accent': '#4CAF50'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .filter-input {
                @apply bg-neutral-800 text-white border border-neutral-600 px-3 py-2 rounded-md text-sm focus:border-green-500 focus:outline-none focus:ring-1 focus:ring-green-500 w-full;
            }
            .filter-label {
                @apply text-neutral-400 uppercase text-xs font-bold tracking-wide mb-1;
            }
            .filter-chip {
                @apply inline-flex items-center gap-1.5 px-2.5 py-1 bg-neutral-800 border border-neutral-700 rounded-full text-xs text-neutral-300 cursor-pointer no-underline hover:border-red-400 hover:text-red-300 transition-colors;
            }
            .filter-chip-remove {
                @apply text-neutral-500 font-bold;
            }
            .filter-chip:hover .filter-chip-remove {
                @apply text-red-400;
            }
        }
        /* Hover preview styles */
        #hover-preview {
            position: fixed;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease-out;
        }
        #hover-preview.visible {
            opacity: 1;
        }
        #hover-preview img {
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            border: 2px solid #404040;
        }
        /* Hide hover preview on mobile */
        @media (max-width: 640px) {
            #hover-preview, #person-hover-preview, #photo-hover-preview { display: none !important; }
        }
        /* Responsive card sizing */
        @media (max-width: 639px) {
            #photo-grid { gap: 2px !important; }
            #photo-grid-wrapper { padding: 0 !important; }
            .photo-card { padding: 0 !important; gap: 0 !important; border: none !important; border-radius: 0 !important; background: transparent !important; }
            .photo-thumb { object-fit: contain !important; width: 100% !important; height: auto !important; border-radius: 0 !important; aspect-ratio: auto !important; }
        }
        @media (min-width: 640px) {
            .photo-card { width: var(--card-width) !important; }
            .photo-card img.photo-thumb { width: var(--image-width) !important; }
        }
        /* Hide details: compact cards with uniform square thumbnails */
        body.details-hidden .photo-card { padding: 0 !important; gap: 0 !important; }
        body.details-hidden .photo-thumb { aspect-ratio: 1; width: 100% !important; }
        /* Photo hover preview with details */
        #photo-hover-preview {
            position: fixed;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease-out;
            display: flex;
            align-items: start;
            gap: 12px;
            background: rgba(23, 23, 23, 0.97);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #404040;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }
        #photo-hover-preview.landscape {
            flex-direction: column;
            gap: 8px;
        }
        #photo-hover-preview.visible {
            opacity: 1;
        }
        #photo-hover-preview img {
            object-fit: contain;
            border-radius: 6px;
        }
        #photo-hover-preview.landscape img {
            width: 100%;
        }
        #photo-hover-preview .preview-details {
            max-width: 260px;
            font-size: 12px;
            line-height: 1.6;
            color: #e5e5e5;
        }
        #photo-hover-preview.landscape .preview-details {
            max-width: none;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0 16px;
        }
        #photo-hover-preview.landscape .preview-details .preview-filename,
        #photo-hover-preview.landscape .preview-details .preview-date,
        #photo-hover-preview.landscape .preview-details .category {
            grid-column: 1 / -1;
        }
        #photo-hover-preview .preview-details .preview-filename {
            font-weight: 600;
            color: #e5e5e5;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #photo-hover-preview .preview-details .preview-date {
            color: #737373;
            font-size: 11px;
            margin-bottom: 4px;
        }
        #photo-hover-preview .preview-details .category {
            font-weight: 600;
            color: #22c55e;
            margin-bottom: 6px;
        }
        #photo-hover-preview .preview-details .score-section {
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px solid #404040;
        }
        #photo-hover-preview .preview-details .score-section-title {
            font-size: 10px;
            color: #737373;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        #photo-hover-preview .preview-details .score-row {
            display: flex;
            justify-content: space-between;
        }
        #photo-hover-preview .preview-details .score-label {
            color: #a3a3a3;
        }
        #photo-hover-preview .preview-details .score-value {
            color: #22c55e;
            font-weight: 500;
        }
        /* Person hover preview styles */
        #person-hover-preview {
            position: fixed;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease-out;
        }
        #person-hover-preview.visible {
            opacity: 1;
        }
        #person-hover-preview img {
            width: 160px;
            height: 160px;
            object-fit: cover;
            border-radius: 50%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            border: 3px solid #22c55e;
        }
        #person-hover-preview .person-name {
            text-align: center;
            margin-top: 8px;
            font-size: 14px;
            color: #e5e5e5;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }
    </style>
</head>
<body class="bg-neutral-950 text-neutral-200 min-h-screen{% if params.hide_details == '1' %} details-hidden{% endif %}">
    <!-- Hover Preview (simple large image) -->
    <div id="hover-preview"><img src="" alt="Preview"></div>
    <!-- Person Hover Preview -->
    <div id="person-hover-preview"><img src="" alt="Person Preview"><div class="person-name"></div></div>
    <!-- Photo Hover Preview with Details -->
    <div id="photo-hover-preview">
        <img src="" alt="Photo Preview">
        <div class="preview-details"></div>
    </div>

    <!-- Compact Header Toolbar -->
    <header class="bg-neutral-900 border-b border-neutral-800 px-3 sm:px-6 py-2 sm:sticky sm:top-0 z-40">
        <!-- Responsive: stacked rows on mobile/tablet, single row on lg+ -->
        <div class="flex flex-col lg:flex-row lg:items-center gap-2">
            <!-- Primary Filters Form -->
            <form id="primaryFilters" method="GET" class="contents">
                <!-- Preserve sort params and toggle states -->
                <input type="hidden" name="sort" value="{{ params.sort }}">
                <input type="hidden" name="dir" value="{{ params.dir }}">
                {% if params.person %}<input type="hidden" name="person" value="{{ params.person }}">{% endif %}
                {% if params.hide_blinks == '1' %}<input type="hidden" name="hide_blinks" value="1">{% endif %}
                {% if params.hide_bursts == '1' %}<input type="hidden" name="hide_bursts" value="1">{% endif %}
                {% if params.hide_duplicates == '1' %}<input type="hidden" name="hide_duplicates" value="1">{% endif %}
                {% if params.hide_details == '1' %}<input type="hidden" name="hide_details" value="1">{% endif %}

                <!-- Row 1 on mobile: Type + Person (single row on lg+) -->
                <div class="flex flex-col sm:flex-row lg:contents gap-2">
                    <!-- Photo Type -->
                    <select name="type" onchange="this.form.elements['sort'].disabled=true; this.form.submit()" class="w-full sm:basis-1/2 lg:w-auto bg-neutral-800 text-white text-sm px-2 py-1.5 rounded border border-neutral-700 focus:border-green-500 focus:outline-none">
                        {% for value, label in photo_types %}
                        <option value="{{ value }}" {% if params.type == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>

                    <!-- Person Filter + Edit -->
                    {% if options.persons %}
                    <div class="w-full sm:basis-1/2 lg:w-auto flex gap-1">
                        <div class="person-dropdown relative flex-1 lg:flex-none">
                            <button type="button" class="person-dropdown-btn w-full lg:w-auto bg-neutral-800 text-white text-sm px-2 py-1.5 rounded border border-neutral-700 hover:border-neutral-600 focus:border-green-500 focus:outline-none flex items-center gap-2">
                                {% if params.person %}
                                    {% for id, name, face_id, count in options.persons if id|string == params.person %}
                                    <img src="/person_thumbnail/{{ id }}" class="w-12 h-12 rounded-full object-cover flex-shrink-0" alt="">
                                    <span class="truncate max-w-[120px]">{{ name or _('manage_persons.person_fallback', id=id) }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="truncate">{{ _('ui.filters.all_people') }}</span>
                                {% endif %}
                                <svg class="w-4 h-4 ml-auto flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </button>
                            <div class="person-dropdown-menu hidden absolute top-full left-0 mt-1 bg-neutral-800 border border-neutral-700 rounded shadow-lg z-50 max-h-64 overflow-y-auto min-w-[200px]">
                                <a href="?{{ params|urlencode_without('person') }}" class="flex items-center gap-2 px-3 py-2 hover:bg-neutral-700 text-white text-sm">
                                    <span class="w-12 h-12"></span>
                                    <span>{{ _('ui.filters.all_people') }}</span>
                                </a>
                                {% for id, name, face_id, count in options.persons %}
                                {% set person_params = params|urlencode_without(['type', 'person']) %}
                                <a href="?{{ person_params ~ ('&' if person_params else '') }}person={{ id }}" class="flex items-center gap-2 px-3 py-2 hover:bg-neutral-700 text-white text-sm {% if params.person == id|string %}bg-neutral-700{% endif %}">
                                    <img src="/person_thumbnail/{{ id }}" class="w-12 h-12 rounded-full object-cover" alt="" loading="lazy">
                                    <span class="truncate">{{ name or _('manage_persons.person_fallback', id=id) }}</span>
                                    <span class="text-neutral-500 ml-auto">({{ count }})</span>
                                </a>
                                {% endfor %}
                                {% if edition_authenticated %}
                                <a href="/manage_persons" class="flex items-center gap-2 px-3 py-2 hover:bg-neutral-700 text-green-500 text-sm border-t border-neutral-700">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    <span>{{ _('manage_persons.title') }}</span>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% if params.person and edition_authenticated %}
                        {% for id, name, face_id, count in options.persons if id|string == params.person %}
                        <button type="button" onclick="renamePerson({{ id }}, '{{ (name or _('manage_persons.person_fallback', id=id))|e }}')" class="flex-shrink-0 bg-neutral-800 text-neutral-400 hover:text-white p-1.5 rounded border border-neutral-700 hover:border-neutral-600" title="{{ _('manage_persons.rename_person') }}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        </button>
                        {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Row 2 on mobile: Tag + Search (single row on lg+) -->
                <div class="flex lg:contents gap-2">
                    <!-- Tag Filter -->
                    {% if options.tags %}
                    <select name="tag" onchange="this.form.submit()" class="basis-1/2 lg:basis-auto lg:w-auto bg-neutral-800 text-white text-sm px-2 py-1.5 rounded border border-neutral-700 focus:border-green-500 focus:outline-none">
                        <option value="">{{ _('ui.filters.tag') }}: {{ _('ui.filters.all') }}</option>
                        {% for tag, count in options.tags %}
                        <option value="{{ tag }}" {% if params.tag == tag %}selected{% endif %}>{{ tag }} ({{ count }})</option>
                        {% endfor %}
                    </select>
                    {% endif %}

                    <!-- Filename Search -->
                    <div class="basis-1/2 lg:basis-auto lg:flex-1 lg:max-w-xs relative">
                        <input type="text" name="search" value="{{ params.search or '' }}" placeholder="{{ _('ui.filters.search') }}..."
                               class="w-full bg-neutral-800 text-white text-sm pl-8 pr-2 py-1.5 rounded border border-neutral-700 focus:border-green-500 focus:outline-none"
                               onkeydown="if(event.key==='Enter'){this.form.submit();}">
                        <svg class="absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                </div>
            </form>

            <!-- Row 3 on mobile: Sort + Buttons (single row on lg+) -->
            <div class="flex lg:contents gap-2 items-center">
                <!-- Sort Controls -->
                <form id="sortForm" method="GET" class="flex-1 lg:flex-none flex items-center gap-1 min-w-0">
                    {% for key, val in params.items() if key not in ['sort', 'dir'] and val %}
                    <input type="hidden" name="{{ key }}" value="{{ val }}">
                    {% endfor %}

                    <select name="sort" onchange="document.getElementById('sortForm').submit()" class="flex-1 lg:flex-none lg:w-auto min-w-0 bg-neutral-800 text-white text-sm px-2 py-1.5 rounded border border-neutral-700 focus:border-green-500 focus:outline-none">
                        {% if sort_options_grouped %}
                            {% for category, options in sort_options_grouped.items() %}
                            <optgroup label="{{ category }}">
                                {% for opt in options %}
                                <option value="{{ opt.column }}" {% if params.sort == opt.column %}selected{% endif %}>{{ opt.label }}</option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        {% else %}
                            {% for value, label in sort_options %}
                            <option value="{{ value }}" {% if params.sort == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>

                    <button type="button" onclick="toggleSortDir()" class="flex-shrink-0 bg-neutral-800 text-white px-2 py-1.5 rounded border border-neutral-700 hover:border-green-500 text-sm" title="{{ _('ui.sort.toggle_direction') }}">
                        {% if params.dir == 'ASC' %}&#8593;{% else %}&#8595;{% endif %}
                    </button>
                    <input type="hidden" name="dir" id="sortDir" value="{{ params.dir }}">
                </form>

                <!-- Filter Toggle Button with Badge -->
                <button onclick="toggleDrawer()" class="flex-shrink-0 relative bg-neutral-800 text-white px-3 py-1.5 rounded border border-neutral-700 hover:border-green-500 flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    <span class="hidden sm:inline">{{ _('ui.buttons.filters') }}</span>
                    {% if active_filter_count > 0 %}
                    <span class="absolute -top-1.5 -right-1.5 bg-green-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">{{ active_filter_count }}</span>
                    {% endif %}
                </button>

                {% if editing_enabled and not edition_authenticated %}
                <!-- Edition Mode Unlock Button -->
                <button onclick="showEditionLoginModal()" class="flex-shrink-0 bg-neutral-800 text-neutral-400 hover:text-yellow-400 px-3 py-1.5 rounded border border-neutral-700 hover:border-yellow-500 flex items-center gap-2 text-sm" title="{{ _('edition.unlock_title') }}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                </button>
                {% elif edition_authenticated %}
                <!-- Edition Mode Active Indicator / Logout Button -->
                <button onclick="editionLogout()" class="flex-shrink-0 bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-1.5 rounded border border-yellow-500 flex items-center gap-2 text-sm" title="{{ _('edition.lock_title') }}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
                    </svg>
                </button>
                {% endif %}

                {% if options.persons and edition_authenticated %}
                <!-- Manage Persons Button -->
                <a href="/manage_persons" class="flex-shrink-0 bg-green-700 hover:bg-green-600 text-white px-3 py-1.5 rounded border border-green-600 flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                    </svg>
                    <span class="hidden sm:inline">{{ _('manage_persons.title') }}</span>
                </a>
                {% endif %}

                {% if edition_authenticated and params.type %}
                <!-- Compare Photos Button -->
                <a href="/compare?type={{ params.type }}" class="flex-shrink-0 bg-purple-700 hover:bg-purple-600 text-white px-3 py-1.5 rounded border border-purple-600 flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <span class="hidden sm:inline">{{ _('ui.buttons.compare') }}</span>
                </a>
                {% endif %}

                <!-- Stats Button -->
                <a href="/stats" class="flex-shrink-0 relative bg-neutral-800 text-white px-3 py-1.5 rounded border border-neutral-700 hover:border-green-500 flex items-center gap-2 text-sm" title="{{ _('stats.title') }}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </a>
            </div>
        </div>
    </header>

    <!-- Active Filter Chips (drawer filters, toggles, and person only) -->
    {% if active_filter_count > 0 %}
    <div class="px-3 sm:px-6 py-2 flex flex-wrap gap-2 bg-neutral-900/50 border-b border-neutral-800">
        {% for key, val in active_filters.items() %}
        <a href="?{% for k, v in params.items() if k != key and v and k not in excluded_url_params %}{{ k }}={{ v }}&{% endfor %}" class="filter-chip">
            {% if key == 'hide_blinks' %}
            {{ _('ui.toggles.hide_blinks') }}
            {% elif key == 'hide_bursts' %}
            {{ _('ui.toggles.best_of_burst') }}
            {% elif key == 'hide_duplicates' %}
            {{ _('ui.toggles.hide_duplicates') }}
            {% elif key == 'hide_details' %}
            {{ _('ui.toggles.hide_details') }}
            {% elif key in ['hide_rejected', 'favorites_only', 'show_rejected'] %}
            {{ filter_labels.get(key, key) }}
            {% else %}
            {{ filter_labels.get(key, key) }}: {{ val }}
            {% endif %}
            <span class="filter-chip-remove">&times;</span>
        </a>
        {% endfor %}
        <a href="/" class="text-red-400 text-xs hover:text-red-300 ml-2 self-center">{{ _('ui.buttons.clear_all') }}</a>
    </div>
    {% endif %}

    <!-- Filter Drawer (hidden by default) - Advanced Filters Only -->
    <div id="filter-drawer" class="fixed left-0 top-0 h-full w-80 bg-neutral-900 border-r border-neutral-800 transform -translate-x-full transition-transform duration-300 z-50 overflow-y-auto">
        <form method="GET" class="h-full flex flex-col">
            <!-- Preserve primary filter params -->
            <input type="hidden" name="sort" value="{{ params.sort }}">
            <input type="hidden" name="dir" value="{{ params.dir }}">
            <input type="hidden" name="type" value="{{ params.type }}">
            {% if params.tag %}<input type="hidden" name="tag" value="{{ params.tag }}">{% endif %}
            {% if params.search %}<input type="hidden" name="search" value="{{ params.search }}">{% endif %}
            {% if params.person %}<input type="hidden" name="person" value="{{ params.person }}">{% endif %}

            <!-- Drawer Header -->
            <div class="flex justify-between items-center p-4 border-b border-neutral-800 sticky top-0 bg-neutral-900">
                <h2 class="text-lg font-semibold text-white">{{ _('drawer.title') }}</h2>
                <button type="button" onclick="toggleDrawer()" class="text-neutral-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            <div class="p-4 space-y-4 flex-1 overflow-y-auto">
                <!-- Display Options Section -->
                <details open class="group">
                    <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-neutral-300 uppercase tracking-wide py-2">
                        {{ _('drawer.sections.display_options') }}
                        <svg class="w-4 h-4 transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </summary>
                    <div class="mt-3 space-y-3">
                        <label class="flex items-center gap-2 text-sm text-neutral-400 cursor-pointer hover:text-neutral-300">
                            <input type="checkbox" name="hide_blinks" value="1" {% if params.hide_blinks == '1' %}checked{% endif %} class="w-4 h-4 rounded bg-neutral-800 border-neutral-600 text-green-500 focus:ring-green-500 focus:ring-offset-neutral-900">
                            <span>{{ _('ui.toggles.hide_blinks') }}</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-neutral-400 cursor-pointer hover:text-neutral-300">
                            <input type="checkbox" name="hide_bursts" value="1" {% if params.hide_bursts == '1' %}checked{% endif %} class="w-4 h-4 rounded bg-neutral-800 border-neutral-600 text-green-500 focus:ring-green-500 focus:ring-offset-neutral-900">
                            <span>{{ _('ui.toggles.best_of_burst') }}</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-neutral-400 cursor-pointer hover:text-neutral-300">
                            <input type="checkbox" name="hide_duplicates" value="1" {% if params.hide_duplicates == '1' %}checked{% endif %} class="w-4 h-4 rounded bg-neutral-800 border-neutral-600 text-green-500 focus:ring-green-500 focus:ring-offset-neutral-900">
                            <span>{{ _('ui.toggles.hide_duplicates') }}</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-neutral-400 cursor-pointer hover:text-neutral-300">
                            <input type="checkbox" name="hide_details" value="1" {% if params.hide_details == '1' %}checked{% endif %} class="w-4 h-4 rounded bg-neutral-800 border-neutral-600 text-green-500 focus:ring-green-500 focus:ring-offset-neutral-900">
                            <span>{{ _('ui.toggles.hide_details') }}</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-neutral-400 cursor-pointer hover:text-neutral-300">
                            <input type="checkbox" name="hide_rejected" value="1" {% if params.hide_rejected == '1' %}checked{% endif %} class="w-4 h-4 rounded bg-neutral-800 border-neutral-600 text-green-500 focus:ring-green-500 focus:ring-offset-neutral-900" onchange="if(this.checked) document.querySelector('input[name=show_rejected]').checked=false">
                            <span>{{ _('rating.hide_rejected') }}</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-neutral-400 cursor-pointer hover:text-neutral-300">
                            <input type="checkbox" name="favorites_only" value="1" {% if params.favorites_only == '1' %}checked{% endif %} class="w-4 h-4 rounded bg-neutral-800 border-neutral-600 text-green-500 focus:ring-green-500 focus:ring-offset-neutral-900">
                            <span>{{ _('rating.favorites_only') }}</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-neutral-400 cursor-pointer hover:text-neutral-300">
                            <input type="checkbox" name="show_rejected" value="1" {% if params.show_rejected == '1' %}checked{% endif %} class="w-4 h-4 rounded bg-neutral-800 border-neutral-600 text-green-500 focus:ring-green-500 focus:ring-offset-neutral-900" onchange="if(this.checked) document.querySelector('input[name=hide_rejected]').checked=false">
                            <span>{{ _('rating.show_rejected') }}</span>
                        </label>
                        <!-- Min rating dropdown -->
                        <div>
                            <label class="filter-label">{{ _('rating.min_rating') }}</label>
                            <select name="min_rating" class="filter-input">
                                <option value="">{{ _('drawer.placeholder') }}</option>
                                <option value="1" {% if params.min_rating == '1' %}selected{% endif %}>★ (1+)</option>
                                <option value="2" {% if params.min_rating == '2' %}selected{% endif %}>★★ (2+)</option>
                                <option value="3" {% if params.min_rating == '3' %}selected{% endif %}>★★★ (3+)</option>
                                <option value="4" {% if params.min_rating == '4' %}selected{% endif %}>★★★★ (4+)</option>
                                <option value="5" {% if params.min_rating == '5' %}selected{% endif %}>★★★★★ (5)</option>
                            </select>
                        </div>
                    </div>
                </details>

                <!-- Date Range Section -->
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-neutral-300 uppercase tracking-wide py-2 border-t border-neutral-800 pt-4">
                        {{ _('drawer.sections.date_range') }}
                        <svg class="w-4 h-4 transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </summary>
                    <div class="mt-3 space-y-3">
                        <div>
                            <label class="filter-label">{{ _('drawer.fields.from_date') }}</label>
                            <input type="date" name="date_from" class="filter-input" value="{{ params.date_from or '' }}">
                        </div>
                        <div>
                            <label class="filter-label">{{ _('drawer.fields.to_date') }}</label>
                            <input type="date" name="date_to" class="filter-input" value="{{ params.date_to or '' }}">
                        </div>
                    </div>
                </details>

                <!-- Score Ranges Section -->
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-neutral-300 uppercase tracking-wide py-2 border-t border-neutral-800 pt-4">
                        {{ _('drawer.sections.score_ranges') }}
                        <svg class="w-4 h-4 transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </summary>
                    <div class="mt-3 space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_aggregate') }}</label>
                                <input type="number" step="0.1" name="min_score" class="filter-input" value="{{ params.min_score or '' }}" placeholder="0">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_aggregate') }}</label>
                                <input type="number" step="0.1" name="max_score" class="filter-input" value="{{ params.max_score or '' }}" placeholder="10">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_aesthetic') }}</label>
                                <input type="number" step="0.1" name="min_aesthetic" class="filter-input" value="{{ params.min_aesthetic or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_aesthetic') }}</label>
                                <input type="number" step="0.1" name="max_aesthetic" class="filter-input" value="{{ params.max_aesthetic or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_sharpness') }}</label>
                                <input type="number" step="0.1" name="min_sharpness" class="filter-input" value="{{ params.min_sharpness or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_sharpness') }}</label>
                                <input type="number" step="0.1" name="max_sharpness" class="filter-input" value="{{ params.max_sharpness or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_exposure') }}</label>
                                <input type="number" step="0.1" name="min_exposure" class="filter-input" value="{{ params.min_exposure or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_exposure') }}</label>
                                <input type="number" step="0.1" name="max_exposure" class="filter-input" value="{{ params.max_exposure or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_color') }}</label>
                                <input type="number" step="0.1" name="min_color" class="filter-input" value="{{ params.min_color or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_color') }}</label>
                                <input type="number" step="0.1" name="max_color" class="filter-input" value="{{ params.max_color or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_composition') }}</label>
                                <input type="number" step="0.1" name="min_composition" class="filter-input" value="{{ params.min_composition or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_composition') }}</label>
                                <input type="number" step="0.1" name="max_composition" class="filter-input" value="{{ params.max_composition or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <!-- Composition Pattern Filter (SAMP-Net) -->
                        {% if options.composition_patterns %}
                        <div class="mt-3">
                            <label class="filter-label">{{ _('drawer.sections.composition_pattern') }}</label>
                            <select name="composition_pattern" class="filter-input w-full">
                                <option value="">{{ _('ui.filters.all_patterns') }}</option>
                                {% for pattern, count in options.composition_patterns %}
                                <option value="{{ pattern }}" {% if params.composition_pattern == pattern %}selected{% endif %}>{{ pattern|replace('_', ' ')|title }} ({{ count }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                    </div>
                </details>

                <!-- Face Metrics Section -->
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-neutral-300 uppercase tracking-wide py-2 border-t border-neutral-800 pt-4">
                        {{ _('drawer.sections.face_metrics') }}
                        <svg class="w-4 h-4 transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </summary>
                    <div class="mt-3 space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_faces') }}</label>
                                <input type="number" name="min_face_count" class="filter-input" value="{{ params.min_face_count or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_faces') }}</label>
                                <input type="number" name="max_face_count" class="filter-input" value="{{ params.max_face_count or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_face_quality') }}</label>
                                <input type="number" step="0.1" name="min_face_quality" class="filter-input" value="{{ params.min_face_quality or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_face_quality') }}</label>
                                <input type="number" step="0.1" name="max_face_quality" class="filter-input" value="{{ params.max_face_quality or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_eye_sharpness') }}</label>
                                <input type="number" step="0.1" name="min_eye_sharpness" class="filter-input" value="{{ params.min_eye_sharpness or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_eye_sharpness') }}</label>
                                <input type="number" step="0.1" name="max_eye_sharpness" class="filter-input" value="{{ params.max_eye_sharpness or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_face_ratio') }}</label>
                                <input type="number" step="0.01" name="min_face_ratio" class="filter-input" value="{{ params.min_face_ratio or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_face_ratio') }}</label>
                                <input type="number" step="0.01" name="max_face_ratio" class="filter-input" value="{{ params.max_face_ratio or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_face_sharpness') }}</label>
                                <input type="number" step="0.1" name="min_face_sharpness" class="filter-input" value="{{ params.min_face_sharpness or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_face_sharpness') }}</label>
                                <input type="number" step="0.1" name="max_face_sharpness" class="filter-input" value="{{ params.max_face_sharpness or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                    </div>
                </details>

                <!-- New Metrics Section -->
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-neutral-300 uppercase tracking-wide py-2 border-t border-neutral-800 pt-4">
                        {{ _('drawer.sections.image_metrics') }}
                        <svg class="w-4 h-4 transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </summary>
                    <div class="mt-3 space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_dynamic_range') }}</label>
                                <input type="number" step="0.1" name="min_dynamic_range" class="filter-input" value="{{ params.min_dynamic_range or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_dynamic_range') }}</label>
                                <input type="number" step="0.1" name="max_dynamic_range" class="filter-input" value="{{ params.max_dynamic_range or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_contrast') }}</label>
                                <input type="number" step="0.1" name="min_contrast" class="filter-input" value="{{ params.min_contrast or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_contrast') }}</label>
                                <input type="number" step="0.1" name="max_contrast" class="filter-input" value="{{ params.max_contrast or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_noise') }}</label>
                                <input type="number" step="0.1" name="min_noise" class="filter-input" value="{{ params.min_noise or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_noise') }}</label>
                                <input type="number" step="0.1" name="max_noise" class="filter-input" value="{{ params.max_noise or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_isolation') }}</label>
                                <input type="number" step="0.1" name="min_isolation" class="filter-input" value="{{ params.min_isolation or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_isolation') }}</label>
                                <input type="number" step="0.1" name="max_isolation" class="filter-input" value="{{ params.max_isolation or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_luminance') }}</label>
                                <input type="number" step="0.01" name="min_luminance" class="filter-input" value="{{ params.min_luminance or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_luminance') }}</label>
                                <input type="number" step="0.01" name="max_luminance" class="filter-input" value="{{ params.max_luminance or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_hist_spread') }}</label>
                                <input type="number" step="0.01" name="min_histogram_spread" class="filter-input" value="{{ params.min_histogram_spread or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_hist_spread') }}</label>
                                <input type="number" step="0.01" name="max_histogram_spread" class="filter-input" value="{{ params.max_histogram_spread or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_power_point') }}</label>
                                <input type="number" step="0.1" name="min_power_point" class="filter-input" value="{{ params.min_power_point or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_power_point') }}</label>
                                <input type="number" step="0.1" name="max_power_point" class="filter-input" value="{{ params.max_power_point or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Camera Settings Section -->
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-neutral-300 uppercase tracking-wide py-2 border-t border-neutral-800 pt-4">
                        {{ _('drawer.sections.camera_settings') }}
                        <svg class="w-4 h-4 transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </summary>
                    <div class="mt-3 space-y-3">
                        <div>
                            <label class="filter-label">{{ _('drawer.fields.camera') }}</label>
                            <select name="camera" class="filter-input">
                                <option value="">{{ _('ui.filters.all_cameras') }}</option>
                                {% for cam in options.cameras %}
                                <option value="{{ cam }}" {% if params.camera == cam %}selected{% endif %}>{{ cam }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="filter-label">{{ _('drawer.fields.lens') }}</label>
                            <select name="lens" class="filter-input">
                                <option value="">{{ _('ui.filters.all_lenses') }}</option>
                                {% for l in options.lenses %}
                                <option value="{{ l }}" {% if params.lens == l %}selected{% endif %}>{{ l }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_iso') }}</label>
                                <input type="number" name="min_iso" class="filter-input" value="{{ params.min_iso or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_iso') }}</label>
                                <input type="number" name="max_iso" class="filter-input" value="{{ params.max_iso or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_fstop') }}</label>
                                <input type="number" step="0.1" name="min_fstop" class="filter-input" value="{{ params.min_fstop or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_fstop') }}</label>
                                <input type="number" step="0.1" name="max_fstop" class="filter-input" value="{{ params.max_fstop or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.min_focal') }}</label>
                                <input type="number" name="min_focal" class="filter-input" value="{{ params.min_focal or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                            <div>
                                <label class="filter-label">{{ _('drawer.fields.max_focal') }}</label>
                                <input type="number" name="max_focal" class="filter-input" value="{{ params.max_focal or '' }}" placeholder="{{ _('drawer.placeholder') }}">
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Drawer Footer Actions (sticky) -->
            <div class="p-4 border-t border-neutral-800 bg-neutral-900 sticky bottom-0 flex gap-3">
                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-500 text-white px-4 py-2.5 rounded-lg font-semibold transition-colors">
                    {{ _('ui.buttons.apply') }}
                </button>
                <a href="/" class="flex-1 bg-neutral-700 hover:bg-neutral-600 text-white px-4 py-2.5 rounded-lg font-semibold transition-colors text-center">
                    {{ _('ui.buttons.reset_all') }}
                </a>
            </div>
        </form>
    </div>

    <!-- Drawer Overlay -->
    <div id="drawer-overlay" class="hidden fixed inset-0 bg-black/50 z-40" onclick="toggleDrawer()"></div>

    <!-- Photo Grid - Tight Layout -->
    <div id="photo-grid-wrapper" class="px-2 py-3">
        <div id="photo-grid" class="flex flex-wrap justify-center gap-2" data-page="{{ page }}" data-total-pages="{{ total_pages }}" data-sort-col="{{ sort_col }}">
            {% for p in photos %}
            <div class="photo-card group bg-neutral-900 flex flex-col gap-1 rounded border border-neutral-800 p-1.5 hover:border-green-500 transition-all w-full sm:w-auto" style="--card-width: {{ viewer_config.display.card_width_px }}px; --image-width: {{ viewer_config.display.image_width_px }}px" data-path="{{ p['path'] | urlencode }}">
                <!-- Thumbnail -->
                <div class="photo-thumb-container flex-initial relative" onclick="toggleSelection(this, '{{ p['filename'] | js_escape }}', '{{ p['path'] | js_escape }}')" data-tooltip="{{ p['filename'] }}&#10;{{ p['date_taken'] | format_date }}&#10;[{{ p['category'] | default('others') | title }}] {{ _('tooltip.aggregate') }}: {{ p['aggregate'] | safe_float(1) }}&#10;&#10;── {{ _('tooltip.quality_section') }} ──&#10;{{ _('tooltip.aesthetic') }}: {{ p['aesthetic'] | safe_float(1) }}{% if p['quality_score'] %}&#10;{{ _('tooltip.quality_score') }}: {{ p['quality_score'] | safe_float(1) }}{% endif %}{% if p['face_count'] > 0 %}&#10;{{ _('tooltip.face_quality') }}: {{ p['face_quality'] | safe_float(1) }}&#10;{{ _('tooltip.face_sharpness') }}: {{ p['face_sharpness'] | safe_float(1) }}&#10;{{ _('tooltip.eye_sharpness') }}: {{ p['eye_sharpness'] | safe_float(1) }}{% endif %}&#10;{{ _('tooltip.tech_sharpness') }}: {{ p['tech_sharpness'] | safe_float(1) }}&#10;&#10;── {{ _('tooltip.composition_section') }} ──&#10;{{ _('tooltip.composition') }}: {{ p['comp_score'] | safe_float(1) }}{% if p['composition_pattern'] %}&#10;{{ _('tooltip.pattern') }}: {{ p['composition_pattern'] | replace('_', ' ') | title }}{% endif %}{% if p['power_point_score'] %}&#10;{{ _('tooltip.power_points') }}: {{ p['power_point_score'] | safe_float(1) }}{% endif %}{% if p['leading_lines_score'] %}&#10;{{ _('tooltip.leading_lines') }}: {{ p['leading_lines_score'] | safe_float(1) }}{% endif %}&#10;&#10;── {{ _('tooltip.technical_section') }} ──&#10;{{ _('tooltip.exposure') }}: {{ p['exposure_score'] | safe_float(1) }}&#10;{{ _('tooltip.color') }}: {{ p['color_score'] | safe_float(1) }}{% if p['contrast_score'] %}&#10;{{ _('tooltip.contrast') }}: {{ p['contrast_score'] | safe_float(1) }}{% endif %}{% if p['dynamic_range_stops'] %}&#10;{{ _('tooltip.dynamic_range') }}: {{ p['dynamic_range_stops'] | safe_float(1) }}{% endif %}{% if p['mean_saturation'] %}&#10;{{ _('tooltip.saturation') }}: {{ p['mean_saturation'] | safe_float(1) }}{% endif %}{% if p['noise_sigma'] %}&#10;{{ _('tooltip.noise') }}: {{ p['noise_sigma'] | safe_float(1) }}{% endif %}&#10;&#10;── {{ _('tooltip.exif_section') }} ──{% if p['camera_model'] %}&#10;{{ _('tooltip.camera') }}: {{ p['camera_model'] }}{% endif %}{% if p['lens_model'] %}&#10;{{ _('tooltip.lens') }}: {{ p['lens_model'] }}{% endif %}&#10;{{ _('tooltip.focal') }}: {{ p['focal_length'] or '?' }}mm&#10;{{ _('tooltip.shutter') }}: {{ p['shutter_speed'] | format_shutter }}&#10;{{ _('tooltip.iso') }}: {{ p['iso'] or '?' }}{% if p['isolation_bonus'] and p['isolation_bonus'] > 1.0 %}&#10;&#10;── {{ _('tooltip.bonus_section') }} ──&#10;{{ _('tooltip.isolation') }}: {{ p['isolation_bonus'] | safe_float(1) }}{% endif %}">
                    <img
                        src="/thumbnail?path={{ p['path'] | urlencode }}&size=640"
                        loading="lazy"
                        class="photo-thumb rounded object-cover cursor-pointer w-full sm:w-auto"
                    >
                    <div class="selection-check hidden absolute top-1 right-1 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    {% if viewer_config.features.show_rating_badge and (p['is_favorite'] or (p['star_rating'] and p['star_rating'] > 0)) %}
                    <div class="rating-badge absolute top-8 right-1 bg-black/70 rounded px-1 py-0.5 text-xs font-medium z-10" data-path="{{ p['path'] | js_escape }}">
                        {% if p['is_favorite'] %}<span class="text-red-400">❤</span>{% elif p['star_rating'] > 0 %}<span class="text-yellow-400">★{{ p['star_rating'] }}</span>{% endif %}
                    </div>
                    {% endif %}
                    {% if edition_authenticated and p['face_count'] > 0 and not params.person %}
                    <button onclick="event.stopPropagation(); showAssignFaceModal('{{ p['path'] | js_escape }}')"
                            class="assign-face-btn opacity-0 group-hover:opacity-100 absolute top-1 left-1 w-6 h-6 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center text-white transition-opacity z-10"
                            title="{{ _('manage_persons.assign_face') }}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                    </button>
                    {% endif %}
                    {% if viewer_config.features.show_similar_button %}
                    <!-- Find Similar Button -->
                    <button onclick="event.stopPropagation(); showSimilarPhotosModal('{{ p['path'] | js_escape }}')"
                            class="similar-btn opacity-0 group-hover:opacity-100 absolute bottom-1 left-1 w-6 h-6 bg-purple-600 hover:bg-purple-500 rounded-full flex items-center justify-center text-white transition-opacity z-10"
                            title="{{ _('similar.find_similar') }}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                    {% endif %}
                    {% if edition_authenticated and viewer_config.features.show_rating_controls %}
                    <!-- Rating controls (edition mode only) -->
                    <div class="rating-controls opacity-0 group-hover:opacity-100 absolute bottom-1 right-1 flex items-center gap-1 bg-black/70 rounded px-1 py-0.5 transition-opacity z-10">
                        <!-- Star rating -->
                        <div class="star-rating flex" data-path="{{ p['path'] | js_escape }}" data-current="{{ p['star_rating'] or 0 }}">
                            {% for i in range(1, 6) %}
                            <button onclick="event.stopPropagation(); setRating('{{ p['path'] | js_escape }}', {{ i }}, this.parentElement)"
                                    class="star-btn text-sm {% if p['star_rating'] and p['star_rating'] >= i %}text-yellow-400{% else %}text-neutral-500 hover:text-yellow-400{% endif %} transition-colors"
                                    title="{{ _('rating.set_rating') }}">★</button>
                            {% endfor %}
                        </div>
                        <!-- Favorite toggle -->
                        <button onclick="event.stopPropagation(); toggleFavorite('{{ p['path'] | js_escape }}', this)"
                                class="favorite-btn text-sm {% if p['is_favorite'] %}text-red-400{% else %}text-neutral-500 hover:text-red-400{% endif %} transition-colors"
                                title="{{ _('rating.favorite') }}"
                                data-favorite="{{ '1' if p['is_favorite'] else '0' }}">❤</button>
                        <!-- Rejected toggle -->
                        <button onclick="event.stopPropagation(); toggleRejected('{{ p['path'] | js_escape }}', this)"
                                class="rejected-btn text-sm {% if p['is_rejected'] %}text-red-600{% else %}text-neutral-500 hover:text-red-600{% endif %} transition-colors"
                                title="{{ _('rating.rejected') }}"
                                data-rejected="{{ '1' if p['is_rejected'] else '0' }}">✕</button>
                    </div>
                    {% endif %}
                </div>

                <!-- Details (stacked below photo) -->
                {% if params.hide_details != '1' %}
                <div class="mt-1.5 text-left">
                    <!-- Always visible: filename + aggregate score -->
                    <div class="flex justify-between text-[12px] items-center">
                        <div class="text-neutral-300 truncate font-medium">{{ p['filename'] }}</div>
                        <span class="text-green-400 font-medium">{{ p['aggregate'] | safe_float(1) }}</span>
                    </div>
                    <!-- Hidden on mobile, visible on sm+ -->
                    <div class="hidden sm:block">
                        <div class="flex justify-between items-center">
                            {% if sort_col == 'date_taken' or sort_col == 'aggregate' %}
                            <span class="text-green-400 font-bold text-base">{{ p['aggregate'] | safe_float(1) }}</span>
                            {% elif sort_col == 'shutter_speed' %}
                            <span class="text-green-400 font-bold text-base">{{ p[sort_col] | format_shutter }}</span>
                            {% elif sort_col == 'composition_pattern' %}
                            <span class="text-green-400 font-bold text-base">{{ (p[sort_col] or 'N/A') | replace('_', ' ') | title }}</span>
                            {% else %}
                            <span class="text-green-400 font-bold text-base">{{ p[sort_col] | safe_float(1) }}</span>
                            {% endif %}
                            <span>{% if p['is_favorite'] %}<span class="text-[10px] font-medium text-red-400 mr-0.5" title="{{ _('rating.favorite') }}">❤</span>{% endif %}{% if p['is_rejected'] %}<span class="text-[10px] font-medium bg-red-900 text-red-400 px-1 rounded mr-0.5">{{ _('ui.badges.rejected') }}</span>{% endif %}{% if p['star_rating'] and p['star_rating'] > 0 %}<span class="text-[10px] font-medium text-yellow-400 mr-0.5">{% for _ in range(p['star_rating']) %}★{% endfor %}</span>{% endif %}{% if p['is_burst_lead'] %}<span class="text-[10px] font-medium bg-green-900 text-green-400 px-1 rounded">{{ _('ui.badges.best') }}</span>{% endif %}{% if p['is_blink'] %} <span class="text-[10px] font-medium bg-amber-900 text-amber-400 px-1 rounded">{{ _('ui.badges.blink') }}</span>{% endif %}{% if p['is_monochrome'] %} <span class="text-[10px] font-medium bg-neutral-700 text-neutral-400 px-1 rounded">{{ _('ui.badges.bw') }}</span>{% endif %}</span>
                        </div>
                        {% if sort_col not in ['aggregate', 'date_taken'] %}
                        <div class="text-[10px] text-neutral-500 -mt-0.5">{{ sort_label }}</div>
                        {% endif %}
                        <div class="flex justify-between text-neutral-400 text-[12px]">
                            <span>{{ p['date_taken'] | format_date }}</span>
                        </div>
                        <div class="flex justify-between text-[12px] text-neutral-500">
                            <span>{{ p['focal_length'] or '?' }}mm f/{{ p['f_stop'] or '?' }}</span>
                            <span>{{ p['shutter_speed'] | format_shutter }} ISO {{ p['iso'] or '?' }}</span>
                        </div>
                        {% if p['tags_list'] %}
                        <div class="flex flex-wrap gap-1 mt-1">
                            {% for tag in p['tags_list'] %}
                            <a href="?tag={{ tag }}" class="text-[10px] px-1.5 py-0.5 bg-neutral-800 text-neutral-400 rounded hover:bg-green-600 hover:text-white transition-colors">{{ tag }}</a>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% if p['persons'] or (edition_authenticated and params.person) %}
                    <div class="flex flex-wrap gap-1 mt-1 items-center">
                        {% if p['persons'] %}
                        {% for person in p['persons'] if person.id|string != params.person %}
                        <a href="?{{ params|urlencode_with('person', person.id) }}" title="{{ person.name }}" class="block">
                            <img src="/person_thumbnail/{{ person.id }}"
                                 alt="{{ person.name }}"
                                 class="w-8 h-8 rounded-full object-cover border border-neutral-700 hover:border-green-500 transition-colors"
                                 loading="lazy">
                        </a>
                        {% endfor %}
                        {% endif %}
                        {% if edition_authenticated and params.person %}
                        <button onclick="event.stopPropagation(); removePersonFromPhoto('{{ p['path'] | js_escape }}', {{ params.person }})"
                                class="remove-person-btn w-8 h-8 rounded-full bg-red-600 hover:bg-red-500 flex items-center justify-center text-white"
                                title="{{ _('manage_persons.remove_person_title') }}">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Infinite Scroll Loading Indicator -->
    <div id="scroll-loader" class="flex justify-center items-center gap-4 py-8 border-t border-neutral-800 {% if page >= total_pages %}hidden{% endif %}">
        <div id="scroll-spinner" class="hidden">
            <svg class="animate-spin h-6 w-6 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        <span id="scroll-status" class="text-neutral-400">
            {{ _('pagination.scroll_for_more') }} &middot; <span id="current-count">{{ photos|length }}</span> {{ _('ui.labels.of') }} {{ total_count }} {{ _('ui.labels.photos') }}
        </span>
    </div>
    <div id="scroll-end" class="{% if page < total_pages %}hidden{% endif %} flex justify-center items-center py-8 border-t border-neutral-800">
        <span class="text-neutral-500">{{ _('pagination.end_of_results') }} &middot; {{ total_count }} {{ _('ui.labels.photos') }}</span>
    </div>

    <!-- Footer with Language Switcher -->
    <footer class="bg-neutral-900 border-t border-neutral-800 py-4 mt-8">
        <div class="flex justify-center items-center gap-2">
            {% for code in supported_languages %}
            <a href="?{{ request.query_string.decode('utf-8') }}&lang={{ code }}"
               class="text-xs px-3 py-1.5 rounded transition-colors {% if lang == code %}bg-green-600 text-white{% else %}bg-neutral-800 text-neutral-400 hover:text-white hover:bg-neutral-700{% endif %}">
                {{ _('language.' ~ code) }}
            </a>
            {% endfor %}
        </div>
    </footer>

    <!-- Selection Toolbar -->
    <div id="selection-toolbar" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 translate-y-20 opacity-0 transition-all duration-300 z-50 bg-neutral-800 border border-neutral-700 rounded-lg shadow-xl px-2 sm:px-4 py-2 sm:py-3 flex items-center gap-2 sm:gap-4">
        <span class="text-neutral-300 hidden sm:inline"><span id="selection-count" class="text-green-400 font-bold">0</span> {{ _('ui.labels.selected') }}</span>
        <span class="text-green-400 font-bold sm:hidden" id="selection-count-mobile">0</span>
        <button onclick="copySelected()" class="hidden sm:flex bg-green-600 hover:bg-green-500 text-white px-4 py-1.5 rounded font-medium transition-colors items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
            </svg>
            <span>{{ _('ui.buttons.copy') }}</span>
        </button>
        <button onclick="downloadSelected()" class="bg-green-600 hover:bg-green-500 text-white px-2 sm:px-4 py-1 sm:py-1.5 rounded font-medium transition-colors flex items-center gap-1 sm:gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <span>{{ _('ui.buttons.download') }}</span>
        </button>
        <button onclick="clearSelection()" class="text-neutral-400 hover:text-white px-1 sm:px-2 py-1 sm:py-1.5 transition-colors">
            <span class="hidden sm:inline">{{ _('ui.buttons.clear') }}</span>
            <svg class="w-4 h-4 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="fixed bottom-4 right-4 z-50 transform translate-y-20 opacity-0 transition-all duration-300 pointer-events-none">
        <div id="toast-container" class="flex items-center gap-3 rounded-lg px-4 py-3 shadow-lg ring-1 ring-inset">
            <svg id="toast-icon-success" class="h-5 w-5 flex-shrink-0 text-green-400 hidden" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/>
            </svg>
            <svg id="toast-icon-error" class="h-5 w-5 flex-shrink-0 text-red-400 hidden" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd"/>
            </svg>
            <p id="toast-text" class="text-sm font-medium"></p>
        </div>
    </div>

    <!-- Fixed loading spinner (bottom-right) -->
    <div id="loading-spinner-fixed" class="hidden fixed bottom-6 right-6 z-50
         bg-neutral-800/90 rounded-full p-3 shadow-lg border border-neutral-700">
        <svg class="animate-spin h-6 w-6 text-green-500" xmlns="http://www.w3.org/2000/svg"
             fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10"
                    stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Face Selection Modal (for selecting which face to assign) -->
    <div id="select-face-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-neutral-900 rounded-lg p-6 max-w-2xl w-full mx-4 border border-neutral-700">
            <h3 class="text-lg font-semibold mb-4">{{ _('manage_persons.select_face') }}</h3>
            <div id="select-face-grid" class="grid grid-cols-4 gap-3 mb-4 max-h-80 overflow-y-auto">
                <!-- Dynamically populated with face thumbnails -->
            </div>
            <button onclick="closeSelectFaceModal()" class="w-full bg-neutral-700 hover:bg-neutral-600 py-2 rounded transition-colors">
                {{ _('ui.buttons.cancel') }}
            </button>
        </div>
    </div>

    <!-- Person Selection Modal (for face assignment) -->
    <div id="select-person-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-neutral-900 rounded-lg p-6 max-w-2xl w-full mx-4 border border-neutral-700">
            <h3 class="text-lg font-semibold mb-4">{{ _('manage_persons.select_person') }}</h3>
            <input type="text" id="person-search" placeholder="{{ _('manage_persons.search_persons') }}" class="w-full bg-neutral-800 text-white px-3 py-2 rounded border border-neutral-700 mb-4 focus:border-green-500 focus:outline-none">
            <div id="select-person-grid" class="grid grid-cols-6 gap-3 mb-4 max-h-80 overflow-y-auto">
                <!-- Dynamically populated -->
            </div>
            <button onclick="closeSelectPersonModal()" class="w-full bg-neutral-700 hover:bg-neutral-600 py-2 rounded transition-colors">
                {{ _('ui.buttons.cancel') }}
            </button>
        </div>
    </div>

    <!-- Similar Photos Modal -->
    <div id="similar-photos-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50" onclick="if(event.target === this) closeSimilarPhotosModal()">
        <div class="bg-neutral-900 rounded-lg p-6 max-w-4xl w-full mx-4 border border-neutral-700 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">{{ _('similar.title') }}</h3>
                <button onclick="closeSimilarPhotosModal()" class="text-neutral-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="similar-photos-loading" class="hidden py-8 text-center text-neutral-400">
                <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                {{ _('similar.loading') }}
            </div>
            <div id="similar-photos-empty" class="hidden py-8 text-center text-neutral-500">
                {{ _('similar.no_results') }}
            </div>
            <div id="similar-photos-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 auto-rows-max gap-4 overflow-y-auto min-h-0 flex-1 p-1">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>

    {% if editing_enabled and not edition_authenticated %}
    <!-- Edition Login Modal -->
    <div id="edition-login-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-neutral-900 rounded-lg p-6 max-w-sm w-full mx-4 border border-neutral-700">
            <h3 class="text-lg font-semibold mb-2">{{ _('edition.unlock_title') }}</h3>
            <p class="text-sm text-neutral-400 mb-4">{{ _('edition.unlock_description') }}</p>
            <form onsubmit="return submitEditionLogin(event)">
                <input type="password" id="edition-password" placeholder="{{ _('edition.password_placeholder') }}"
                       class="w-full bg-neutral-800 text-white px-3 py-2 rounded border border-neutral-700 mb-3 focus:border-yellow-500 focus:outline-none"
                       autocomplete="current-password">
                <div id="edition-login-error" class="hidden text-red-400 text-sm mb-3"></div>
                <div class="flex gap-2">
                    <button type="button" onclick="closeEditionLoginModal()" class="flex-1 bg-neutral-700 hover:bg-neutral-600 py-2 rounded transition-colors">
                        {{ _('ui.buttons.cancel') }}
                    </button>
                    <button type="submit" class="flex-1 bg-yellow-600 hover:bg-yellow-500 py-2 rounded transition-colors font-medium">
                        {{ _('edition.unlock_button') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- JavaScript -->
    <script>
        // i18n translations
        const I18N = {{ js_translations(['manage_persons', 'notifications', 'ui', 'similar', 'rating', 'edition', 'tooltip']) | tojson | safe }};
        const FEATURES = {{ viewer_config.features | tojson | safe }};
        const EDITION_AUTHENTICATED = {{ edition_authenticated | tojson }};
        const currentPersonFilter = {{ params.person|tojson if params.person else 'null' }};
        function t(key, vars={}) {
            const keys = key.split('.');
            let value = I18N;
            for (const k of keys) {
                if (value && typeof value === 'object' && k in value) {
                    value = value[k];
                } else {
                    return key;
                }
            }
            if (typeof value === 'string' && Object.keys(vars).length > 0) {
                return value.replace(/\{(\w+)\}/g, (m, k) => vars[k] !== undefined ? vars[k] : m);
            }
            return value || key;
        }

        // Global helper: format number with decimals
        function safeFloat(val, decimals) {
            if (val === null || val === undefined || val === '') return '?';
            return parseFloat(val).toFixed(decimals);
        }

        // Selection state
        const selectedPhotos = new Map(); // filename -> {element, path}

        function toggleDrawer() {
            const drawer = document.getElementById('filter-drawer');
            const overlay = document.getElementById('drawer-overlay');
            const isOpen = !drawer.classList.contains('-translate-x-full');

            if (isOpen) {
                // Close drawer - explicit state to prevent desync
                drawer.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            } else {
                // Open drawer
                drawer.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }
        }

        function toggleSortDir() {
            const dirInput = document.getElementById('sortDir');
            dirInput.value = dirInput.value === 'ASC' ? 'DESC' : 'ASC';
            document.getElementById('sortForm').submit();
        }

        // Edition mode login
        function showEditionLoginModal() {
            const modal = document.getElementById('edition-login-modal');
            if (modal) {
                modal.classList.remove('hidden');
                document.getElementById('edition-password').focus();
            }
        }

        function closeEditionLoginModal() {
            const modal = document.getElementById('edition-login-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('edition-password').value = '';
                document.getElementById('edition-login-error').classList.add('hidden');
            }
        }

        function submitEditionLogin(event) {
            event.preventDefault();
            const password = document.getElementById('edition-password').value;
            const errorEl = document.getElementById('edition-login-error');

            fetch('/api/edition/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ password: password })
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok && data.success) {
                    // Reload page to show edition features
                    window.location.reload();
                } else {
                    errorEl.textContent = data.error || t('edition.invalid_password');
                    errorEl.classList.remove('hidden');
                }
            })
            .catch(err => {
                errorEl.textContent = t('notifications.connection_error');
                errorEl.classList.remove('hidden');
            });

            return false;
        }

        function editionLogout() {
            fetch('/api/edition/logout', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(() => window.location.reload())
            .catch(() => window.location.reload());
        }

        // Person dropdown toggle
        document.querySelectorAll('.person-dropdown').forEach(dropdown => {
            const btn = dropdown.querySelector('.person-dropdown-btn');
            const menu = dropdown.querySelector('.person-dropdown-menu');

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.classList.toggle('hidden');
            });
        });

        // Rename person function
        function renamePerson(personId, currentName) {
            const newName = prompt(t('manage_persons.enter_new_name'), currentName);
            if (newName !== null && newName.trim() !== currentName) {
                const formData = new FormData();
                formData.append('name', newName.trim());
                fetch('/rename_person/' + personId, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(t('notifications.person_renamed', {name: data.name}));
                        location.reload();
                    } else {
                        showToast(t('notifications.failed_rename'), true);
                    }
                })
                .catch(() => showToast(t('notifications.failed_rename'), true));
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.person-dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        });

        // Close drawer on Escape key, clear selection on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const drawer = document.getElementById('filter-drawer');
                if (!drawer.classList.contains('-translate-x-full')) {
                    toggleDrawer();
                } else if (selectedPhotos.size > 0) {
                    clearSelection();
                }
            }
        });

        // Toggle photo selection
        function toggleSelection(element, filename, path) {
            const checkmark = element.querySelector('.selection-check');
            const card = element.closest('.bg-neutral-900');

            if (selectedPhotos.has(filename)) {
                // Deselect
                selectedPhotos.delete(filename);
                checkmark.classList.add('hidden');
                card.classList.remove('border-green-500', 'ring-2', 'ring-green-500');
                card.classList.add('border-neutral-800');
            } else {
                // Select
                selectedPhotos.set(filename, {element: element, path: path});
                checkmark.classList.remove('hidden');
                card.classList.remove('border-neutral-800');
                card.classList.add('border-green-500', 'ring-2', 'ring-green-500');
            }

            updateToolbar();
        }

        // Update selection toolbar visibility and count
        function updateToolbar() {
            const toolbar = document.getElementById('selection-toolbar');
            const countEl = document.getElementById('selection-count');
            const countElMobile = document.getElementById('selection-count-mobile');
            countEl.textContent = selectedPhotos.size;
            countElMobile.textContent = selectedPhotos.size;

            if (selectedPhotos.size > 0) {
                toolbar.classList.remove('translate-y-20', 'opacity-0');
                toolbar.classList.add('translate-y-0', 'opacity-100');
            } else {
                toolbar.classList.remove('translate-y-0', 'opacity-100');
                toolbar.classList.add('translate-y-20', 'opacity-0');
            }
        }

        // Copy selected filenames to clipboard
        function copySelected() {
            if (selectedPhotos.size === 0) return;

            const filenames = Array.from(selectedPhotos.keys()).join('\\n');
            navigator.clipboard.writeText(filenames).then(function() {
                const count = selectedPhotos.size;
                showToast(t(count > 1 ? 'notifications.copied_count_plural' : 'notifications.copied_count', {count: count}));
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
            });
        }

        // Download selected photos as ZIP
        function downloadSelected() {
            if (selectedPhotos.size === 0) return;

            const paths = Array.from(selectedPhotos.values()).map(function(d) { return d.path; });
            const count = paths.length;
            showToast(t(count > 1 ? 'notifications.downloading_count_plural' : 'notifications.downloading_count', {count: count}));

            // Download files sequentially with small delay to avoid browser blocking
            let index = 0;
            function downloadNext() {
                if (index >= paths.length) {
                    showToast(t(count > 1 ? 'notifications.downloaded_count_plural' : 'notifications.downloaded_count', {count: count}));
                    return;
                }
                const path = paths[index];
                const a = document.createElement('a');
                a.href = '/api/download?path=' + encodeURIComponent(path);
                a.download = '';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                index++;
                if (index < paths.length) {
                    setTimeout(downloadNext, 300);
                } else {
                    showToast(t(count > 1 ? 'notifications.downloaded_count_plural' : 'notifications.downloaded_count', {count: count}));
                }
            }
            downloadNext();
        }

        // Clear all selections
        function clearSelection() {
            selectedPhotos.forEach(function(data, filename) {
                const checkmark = data.element.querySelector('.selection-check');
                const card = data.element.closest('.bg-neutral-900');
                checkmark.classList.add('hidden');
                card.classList.remove('border-green-500', 'ring-2', 'ring-green-500');
                card.classList.add('border-neutral-800');
            });
            selectedPhotos.clear();
            updateToolbar();
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const container = document.getElementById('toast-container');
            const text = document.getElementById('toast-text');
            const iconSuccess = document.getElementById('toast-icon-success');
            const iconError = document.getElementById('toast-icon-error');

            text.textContent = message;
            if (isError) {
                container.className = 'flex items-center gap-3 rounded-lg px-4 py-3 shadow-lg ring-1 ring-inset bg-red-900 text-red-200 ring-red-700/50';
                iconSuccess.classList.add('hidden');
                iconError.classList.remove('hidden');
            } else {
                container.className = 'flex items-center gap-3 rounded-lg px-4 py-3 shadow-lg ring-1 ring-inset bg-green-900 text-green-200 ring-green-700/50';
                iconError.classList.add('hidden');
                iconSuccess.classList.remove('hidden');
            }

            toast.classList.remove('translate-y-20', 'opacity-0', 'pointer-events-none');
            if (toast._hideTimer) clearTimeout(toast._hideTimer);
            toast._hideTimer = setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0', 'pointer-events-none');
            }, {{ viewer_config.notification_duration_ms }});
        }

        // Infinite Scroll
        (function() {
            const photoGrid = document.getElementById('photo-grid');
            const scrollLoader = document.getElementById('scroll-loader');
            const scrollSpinner = document.getElementById('scroll-spinner');
            const loadingSpinnerFixed = document.getElementById('loading-spinner-fixed');
            const scrollStatus = document.getElementById('scroll-status');
            const scrollEnd = document.getElementById('scroll-end');
            const currentCountEl = document.getElementById('current-count');
            const cardWidth = {{ viewer_config.display.card_width_px }};
            const imageWidth = {{ viewer_config.display.image_width_px }};

            let currentPage = parseInt(photoGrid.dataset.page);
            let totalPages = parseInt(photoGrid.dataset.totalPages);
            let sortCol = photoGrid.dataset.sortCol;
            let isLoading = false;
            let loadedCount = parseInt(currentCountEl.textContent);
            const hideDetails = document.body.classList.contains('details-hidden');

            // Track loaded photo paths to prevent duplicates during infinite scroll
            const loadedPaths = new Set();
            // Populate with initial photos from server render
            document.querySelectorAll('.photo-card[data-path]').forEach(card => {
                loadedPaths.add(decodeURIComponent(card.dataset.path));
            });

            // Get current URL params for API calls
            function getQueryParams() {
                return window.location.search;
            }

            // Format number with 1 decimal
            function safeFloat(val, decimals) {
                if (val === null || val === undefined || val === '') return '?';
                return parseFloat(val).toFixed(decimals);
            }

            // Format shutter speed as fraction
            function formatShutter(val) {
                if (!val || val === 0) return '?';
                const v = parseFloat(val);
                if (v >= 1) return v.toFixed(1) + 's';
                return '1/' + Math.round(1/v);
            }

            // Format date
            function formatDate(val) {
                if (!val) return '';
                try {
                    const parts = val.substring(0, 19).split(' ');
                    const dateParts = parts[0].split(':');
                    const timeParts = parts[1] ? parts[1].split(':') : ['00', '00'];
                    return `${dateParts[2]}/${dateParts[1]}/${dateParts[0]} ${timeParts[0]}:${timeParts[1]}`;
                } catch (e) {
                    return val.split(' ')[0].replace(/:/g, '/');
                }
            }

            // Format shutter speed
            function formatShutter(val) {
                if (!val) return '?';
                const v = parseFloat(val);
                if (v >= 1) return v.toFixed(1) + 's';
                return '1/' + Math.round(1/v);
            }

            // Create photo card HTML
            function createPhotoCard(p) {
                const tags = (p.tags_list || []).map(tag =>
                    `<a href="?tag=${encodeURIComponent(tag)}" class="text-[10px] px-1.5 py-0.5 bg-neutral-800 text-neutral-400 rounded hover:bg-green-600 hover:text-white transition-colors">${tag}</a>`
                ).join('');

                const escapedFilename = p.filename.replace(/\\/g, '\\\\').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                const escapedPath = p.path.replace(/\\/g, '\\\\').replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                // Build person avatars (hide only on person_viewer page, exclude current person filter)
                const isPersonViewer = window.location.pathname.startsWith('/person/');
                const currentPersonFilter = new URLSearchParams(window.location.search).get('person');
                const filteredPersons = (p.persons || []).filter(person => String(person.id) !== currentPersonFilter);
                const removePersonBtn = EDITION_AUTHENTICATED && currentPersonFilter ? `
                    <button onclick="event.stopPropagation(); removePersonFromPhoto('${escapedPath}', ${currentPersonFilter})"
                            class="remove-person-btn w-8 h-8 rounded-full bg-red-600 hover:bg-red-500 flex items-center justify-center text-white"
                            title="Remove person from this photo">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>` : '';
                const hasPersonContent = (!isPersonViewer && filteredPersons.length > 0) || removePersonBtn;
                const personsInner = (!isPersonViewer ? filteredPersons.map(person => {
                        const url = new URLSearchParams(window.location.search);
                        url.set('person', person.id);
                        return `<a href="?${url.toString()}" title="${person.name}" class="block">
                            <img src="/person_thumbnail/${person.id}"
                                 alt="${person.name}"
                                 class="w-8 h-8 rounded-full object-cover border border-neutral-700 hover:border-green-500 transition-colors"
                                 loading="lazy">
                        </a>`;
                    }).join('') : '') + removePersonBtn;
                const persons = hasPersonContent
                    ? `<div class="flex flex-wrap gap-1 mt-1 items-center">${personsInner}</div>`
                    : '';

                // Rating badges
                const starRating = p.star_rating || 0;
                const starBadge = starRating > 0 ? `<span class="text-[10px] font-medium text-yellow-400 mr-0.5">${'★'.repeat(starRating)}</span>` : '';
                const favBadge = p.is_favorite ? `<span class="text-[10px] font-medium text-red-400 mr-0.5" title="${t('rating.favorite')}">❤</span>` : '';
                const rejBadge = p.is_rejected ? `<span class="text-[10px] font-medium bg-red-900 text-red-400 px-1 rounded mr-0.5">${t('ui.badges.rejected')}</span>` : '';

                const badges = [
                    favBadge,
                    rejBadge,
                    starBadge,
                    p.is_burst_lead ? `<span class="text-[10px] font-medium bg-green-900 text-green-400 px-1 rounded">${t('ui.badges.best')}</span>` : '',
                    p.is_blink ? `<span class="text-[10px] font-medium bg-amber-900 text-amber-400 px-1 rounded">${t('ui.badges.blink')}</span>` : '',
                    (p.duplicate_group_id && !p.is_duplicate_lead) ? `<span class="text-[10px] font-medium bg-purple-900 text-purple-400 px-1 rounded">${t('ui.badges.dup')}</span>` : '',
                    p.is_monochrome ? `<span class="text-[10px] font-medium bg-neutral-700 text-neutral-400 px-1 rounded">${t('ui.badges.bw')}</span>` : ''
                ].filter(b => b).join(' ');

                // Build tooltip with all scoring properties
                const category = (p.category || 'others').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                let tooltip = `${p.filename}&#10;${p.date_formatted || ''}&#10;[${category}] ${t('tooltip.aggregate')}: ${safeFloat(p.aggregate, 1)}&#10;&#10;── ${t('tooltip.quality_section')} ──&#10;${t('tooltip.aesthetic')}: ${safeFloat(p.aesthetic, 1)}`;
                if (p.quality_score) tooltip += `&#10;${t('tooltip.quality_score')}: ${safeFloat(p.quality_score, 1)}`;
                if (p.face_count > 0) {
                    tooltip += `&#10;${t('tooltip.face_quality')}: ${safeFloat(p.face_quality, 1)}`;
                    tooltip += `&#10;${t('tooltip.face_sharpness')}: ${safeFloat(p.face_sharpness, 1)}`;
                    tooltip += `&#10;${t('tooltip.eye_sharpness')}: ${safeFloat(p.eye_sharpness, 1)}`;
                }
                tooltip += `&#10;${t('tooltip.tech_sharpness')}: ${safeFloat(p.tech_sharpness, 1)}`;
                tooltip += `&#10;&#10;── ${t('tooltip.composition_section')} ──&#10;${t('tooltip.composition')}: ${safeFloat(p.comp_score, 1)}`;
                if (p.composition_pattern) tooltip += `&#10;${t('tooltip.pattern')}: ${p.composition_pattern.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}`;
                if (p.power_point_score) tooltip += `&#10;${t('tooltip.power_points')}: ${safeFloat(p.power_point_score, 1)}`;
                if (p.leading_lines_score) tooltip += `&#10;${t('tooltip.leading_lines')}: ${safeFloat(p.leading_lines_score, 1)}`;
                tooltip += `&#10;&#10;── ${t('tooltip.technical_section')} ──&#10;${t('tooltip.exposure')}: ${safeFloat(p.exposure_score, 1)}&#10;${t('tooltip.color')}: ${safeFloat(p.color_score, 1)}`;
                if (p.contrast_score) tooltip += `&#10;${t('tooltip.contrast')}: ${safeFloat(p.contrast_score, 1)}`;
                if (p.dynamic_range_stops) tooltip += `&#10;${t('tooltip.dynamic_range')}: ${safeFloat(p.dynamic_range_stops, 1)}`;
                if (p.mean_saturation) tooltip += `&#10;${t('tooltip.saturation')}: ${safeFloat(p.mean_saturation, 1)}`;
                if (p.noise_sigma) tooltip += `&#10;${t('tooltip.noise')}: ${safeFloat(p.noise_sigma, 1)}`;
                tooltip += `&#10;&#10;── ${t('tooltip.exif_section')} ──`;
                if (p.camera_model) tooltip += `&#10;${t('tooltip.camera')}: ${p.camera_model}`;
                if (p.lens_model) tooltip += `&#10;${t('tooltip.lens')}: ${p.lens_model}`;
                tooltip += `&#10;${t('tooltip.focal')}: ${p.focal_length || '?'}mm&#10;${t('tooltip.shutter')}: ${formatShutter(p.shutter_speed)}&#10;${t('tooltip.iso')}: ${p.iso || '?'}`;
                if (p.isolation_bonus && p.isolation_bonus > 1.0) tooltip += `&#10;&#10;── ${t('tooltip.bonus_section')} ──&#10;${t('tooltip.isolation')}: ${safeFloat(p.isolation_bonus, 1)}`;

                // Sort value display
                let sortValue;
                if (sortCol === 'date_taken' || sortCol === 'aggregate') {
                    sortValue = `<span class="text-green-400 font-bold text-base">${safeFloat(p.aggregate, 1)}</span>`;
                } else if (sortCol === 'shutter_speed') {
                    sortValue = `<span class="text-green-400 font-bold text-base" title="${t('tooltip.shutter')}">${formatShutter(p[sortCol])}</span>`;
                } else if (sortCol === 'composition_pattern') {
                    const pattern = p[sortCol] || t('ui.labels.na');
                    sortValue = `<span class="text-green-400 font-bold text-base" title="${t('tooltip.composition')}">${pattern.replace(/_/g, ' ')}</span>`;
                } else {
                    sortValue = `<span class="text-green-400 font-bold text-base">${safeFloat(p[sortCol], 1)}</span>`;
                }

                // Details: hidden entirely when hideDetails is on
                const detailsHtml = hideDetails ? '' : `
                        <div class="flex justify-between text-[12px] items-center">
                            <div class="text-neutral-300 truncate font-medium">${p.filename}</div>
                            <span class="text-green-400 font-medium">${safeFloat(p.aggregate, 1)}</span>
                        </div>
                        <div class="hidden sm:block">
                            <div class="flex justify-between items-center">
                                ${sortValue}
                                <span>${badges}</span>
                            </div>
                            <div class="flex justify-between text-neutral-400 text-[12px]">
                                <span>${p.date_formatted || ''}</span>
                            </div>
                            <div class="flex justify-between text-[12px] text-neutral-500">
                                <span>${p.focal_length || '?'}mm f/${p.f_stop || '?'}</span>
                                <span>${formatShutter(p.shutter_speed)} ISO ${p.iso || '?'}</span>
                            </div>
                            ${tags ? `<div class="flex flex-wrap gap-1 mt-1">${tags}</div>` : ''}
                        </div>`;
                const personsHtml = hideDetails ? '' : persons;

                return `
                <div class="photo-card group bg-neutral-900 flex flex-col gap-1 rounded border border-neutral-800 p-1.5 hover:border-green-500 transition-all w-full sm:w-auto" style="--card-width: ${cardWidth}px; --image-width: ${imageWidth}px" data-path="${encodeURIComponent(p.path)}">
                    <div class="photo-thumb-container flex-initial relative" onclick="toggleSelection(this, '${escapedFilename}', '${escapedPath}')" data-tooltip="${tooltip}">
                        <img src="/thumbnail?path=${encodeURIComponent(p.path)}&size=640" loading="lazy" class="photo-thumb rounded object-cover cursor-pointer w-full sm:w-auto">
                        <div class="selection-check hidden absolute top-1 right-1 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        ${FEATURES.show_rating_badge && (p.is_favorite || (p.star_rating && p.star_rating > 0)) ? `
                        <div class="rating-badge absolute top-8 right-1 bg-black/70 rounded px-1 py-0.5 text-xs font-medium z-10" data-path="${escapedPath}">
                            ${p.is_favorite ? '<span class="text-red-400">❤</span>' : `<span class="text-yellow-400">★${p.star_rating}</span>`}
                        </div>` : ''}
                        ${EDITION_AUTHENTICATED && (p.face_count || 0) > 0 && !currentPersonFilter ? `
                        <button onclick="event.stopPropagation(); showAssignFaceModal('${escapedPath}')"
                                class="assign-face-btn opacity-0 group-hover:opacity-100 absolute top-1 left-1 w-6 h-6 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center text-white transition-opacity z-10"
                                title="{{ _('manage_persons.assign_face') }}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                        </button>` : ''}
                        ${FEATURES.show_similar_button ? `<button onclick="event.stopPropagation(); showSimilarPhotosModal('${escapedPath}')"
                                class="similar-btn opacity-0 group-hover:opacity-100 absolute bottom-1 left-1 w-6 h-6 bg-purple-600 hover:bg-purple-500 rounded-full flex items-center justify-center text-white transition-opacity z-10"
                                title="${t('similar.find_similar')}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </button>` : ''}
                    </div>
                    ${!hideDetails ? `<div class="mt-1.5 text-left">
                        ${detailsHtml}
                        ${personsHtml}
                    </div>` : ''}
                </div>`;
            }

            // Load more photos
            async function loadMorePhotos() {
                if (isLoading || currentPage >= totalPages) return;

                isLoading = true;
                scrollSpinner.classList.remove('hidden');
                if (loadingSpinnerFixed) loadingSpinnerFixed.classList.remove('hidden');

                try {
                    const nextPage = currentPage + 1;
                    const params = new URLSearchParams(window.location.search);
                    params.set('page', nextPage);

                    const response = await fetch('/api/photos?' + params.toString());

                    // Check response status before parsing JSON
                    if (!response.ok) {
                        console.error('API request failed:', response.status, response.statusText);
                        return;
                    }

                    let data;
                    try {
                        data = await response.json();
                    } catch (jsonErr) {
                        console.error('Failed to parse API response:', jsonErr);
                        return;
                    }

                    if (data.error) {
                        console.error('API error:', data.error);
                        return;
                    }

                    // Append new photos (skip duplicates)
                    let addedCount = 0;
                    data.photos.forEach(photo => {
                        if (!loadedPaths.has(photo.path)) {
                            loadedPaths.add(photo.path);
                            photoGrid.insertAdjacentHTML('beforeend', createPhotoCard(photo));
                            addedCount++;
                        }
                    });

                    currentPage = data.page;
                    totalPages = data.total_pages;
                    loadedCount += addedCount;
                    currentCountEl.textContent = loadedCount;

                    // Update/hide loader if no more pages
                    if (!data.has_more) {
                        scrollLoader.classList.add('hidden');
                        scrollEnd.classList.remove('hidden');
                    }
                } catch (err) {
                    console.error('Failed to load photos:', err);
                } finally {
                    isLoading = false;
                    scrollSpinner.classList.add('hidden');
                    if (loadingSpinnerFixed) loadingSpinnerFixed.classList.add('hidden');

                    // Check if we need to load more (loader still visible after load)
                    requestAnimationFrame(() => {
                        if (currentPage < totalPages && isElementInViewport(scrollLoader)) {
                            loadMorePhotos();
                        }
                    });
                }
            }

            // Check if element is in viewport
            function isElementInViewport(el) {
                const rect = el.getBoundingClientRect();
                return rect.top < window.innerHeight + 500 && rect.bottom > 0;
            }

            // Scroll detection using IntersectionObserver (more reliable than scroll events)
            function checkScroll() {
                if (isLoading || currentPage >= totalPages) return;

                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const windowHeight = window.innerHeight;
                const docHeight = document.documentElement.scrollHeight;

                // Load more when within 500px of bottom (increased threshold)
                if (scrollTop + windowHeight >= docHeight - 500) {
                    loadMorePhotos();
                }
            }

            // Use IntersectionObserver for reliable scroll detection
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver(function(entries) {
                    entries.forEach(function(entry) {
                        if (entry.isIntersecting && !isLoading && currentPage < totalPages) {
                            loadMorePhotos();
                        }
                    });
                }, {
                    rootMargin: '500px 0px',  // Trigger 500px before visible
                    threshold: 0
                });
                observer.observe(scrollLoader);
            } else {
                // Fallback: Throttle scroll events for browsers without IntersectionObserver
                let scrollTimeout;
                window.addEventListener('scroll', function() {
                    if (scrollTimeout) return;
                    scrollTimeout = setTimeout(function() {
                        scrollTimeout = null;
                        checkScroll();
                    }, 100);
                });
            }

            // Also check on initial load in case page is short
            setTimeout(checkScroll, 500);

            // Debug: Log scroll state for troubleshooting
            console.log('Infinite scroll initialized:', {
                currentPage: currentPage,
                totalPages: totalPages,
                loadedCount: loadedCount,
                isLoading: isLoading
            });
        })();

        // Hover preview functionality
        (function() {
            const preview = document.getElementById('hover-preview');
            const previewImg = preview.querySelector('img');
            const personPreview = document.getElementById('person-hover-preview');
            const personPreviewImg = personPreview.querySelector('img');
            const personPreviewName = personPreview.querySelector('.person-name');
            const photoPreview = document.getElementById('photo-hover-preview');
            const photoPreviewImg = photoPreview.querySelector('img');
            const photoPreviewDetails = photoPreview.querySelector('.preview-details');
            const hideDetails = document.body.classList.contains('details-hidden');
            let hoverTimeout = null;

            function isPhotoThumbnail(img) {
                return img.src && img.src.includes('/thumbnail?');
            }

            function isPersonThumbnail(img) {
                return img.src && img.src.includes('/person_thumbnail/');
            }

            function parseTooltipData(tooltipStr) {
                // Parse the tooltip string into structured data
                const lines = tooltipStr.split(/&#10;|\n/).filter(l => l.trim());
                const data = { sections: [], filename: '', date: '' };
                let currentSection = null;
                let headerLines = [];

                for (const line of lines) {
                    if (line.startsWith('[')) {
                        // Category and aggregate line — preceding lines are filename/date
                        if (headerLines.length >= 1) data.filename = headerLines[0];
                        if (headerLines.length >= 2) data.date = headerLines[1];
                        const match = line.match(/\[([^\]]+)\]\s*.+?:\s*([\d.]+)/);
                        if (match) {
                            data.category = match[1];
                            data.aggregate = match[2];
                        }
                    } else if (line.startsWith('──')) {
                        // Section header
                        const title = line.replace(/──/g, '').trim();
                        currentSection = { title, scores: [] };
                        data.sections.push(currentSection);
                    } else if (line.includes(':') && currentSection) {
                        // Score line
                        const [label, value] = line.split(':').map(s => s.trim());
                        if (label && value) {
                            currentSection.scores.push({ label, value });
                        }
                    } else if (!data.category) {
                        // Lines before category = filename, date
                        headerLines.push(line);
                    }
                }
                return data;
            }

            function buildDetailsHtml(data) {
                let html = '';
                if (data.filename) html += `<div class="preview-filename">${data.filename}</div>`;
                if (data.date) html += `<div class="preview-date">${data.date}</div>`;
                html += `<div class="category">[${data.category}] ${t('tooltip.aggregate')}: ${data.aggregate}</div>`;
                for (const section of data.sections) {
                    html += `<div class="score-section">`;
                    html += `<div class="score-section-title">${section.title}</div>`;
                    for (const score of section.scores) {
                        html += `<div class="score-row"><span class="score-label">${score.label}</span><span class="score-value">${score.value}</span></div>`;
                    }
                    html += `</div>`;
                }
                return html;
            }

            function getPreviewSizes(isLandscape) {
                const vh = window.innerHeight;
                const vw = window.innerWidth;
                const simple = Math.round(Math.min(Math.max(Math.min(vh, vw) * 0.4, 200), 640));
                if (isLandscape) {
                    // Landscape: photo on top, 2-col details below
                    const imgW = Math.round(Math.min(Math.max(vw * 0.25, 250), 450));
                    return { detailImg: imgW, detailWidth: imgW + 20, detailHeight: Math.round(vh * 0.5), simple };
                } else {
                    // Portrait: side-by-side, image takes full height
                    const imgH = Math.round(Math.min(vh * 0.55, 500));
                    return { detailImg: imgH, detailWidth: imgH + 280, detailHeight: imgH + 20, simple };
                }
            }

            function showPreview(e) {
                const img = e.target;
                if (!isPhotoThumbnail(img)) return;

                if (hoverTimeout) {
                    clearTimeout(hoverTimeout);
                    hoverTimeout = null;
                }

                // Check if we should show details
                const container = img.closest('.photo-thumb-container');
                const tooltipData = container?.getAttribute('data-tooltip');

                // Detect aspect ratio from the grid thumbnail
                const isLandscape = img.naturalWidth > img.naturalHeight;
                const sizes = getPreviewSizes(isLandscape);

                if (tooltipData) {
                    // Toggle layout class based on orientation
                    photoPreview.classList.toggle('landscape', isLandscape);
                    // Show photo preview with details
                    photoPreviewImg.src = img.src.replace('size=320', 'size=640');
                    if (isLandscape) {
                        photoPreviewImg.style.width = sizes.detailImg + 'px';
                        photoPreviewImg.style.height = 'auto';
                    } else {
                        photoPreviewImg.style.height = sizes.detailImg + 'px';
                        photoPreviewImg.style.width = 'auto';
                    }
                    const data = parseTooltipData(tooltipData);
                    photoPreviewDetails.innerHTML = buildDetailsHtml(data);
                    positionPreview(e, photoPreview, sizes.detailWidth, sizes.detailHeight);
                    photoPreview.classList.add('visible');
                } else {
                    // Show simple large preview
                    previewImg.src = img.src.replace('size=320', 'size=480');
                    previewImg.style.maxWidth = sizes.simple + 'px';
                    previewImg.style.maxHeight = sizes.simple + 'px';
                    positionPreview(e, preview, sizes.simple, sizes.simple);
                    preview.classList.add('visible');
                }
            }

            function showPersonPreview(e) {
                const img = e.target;
                if (!isPersonThumbnail(img)) return;

                if (hoverTimeout) {
                    clearTimeout(hoverTimeout);
                    hoverTimeout = null;
                }

                personPreviewImg.src = img.src;
                personPreviewName.textContent = img.alt || img.closest('a')?.title || '';
                positionPreview(e, personPreview, 160, 200);
                personPreview.classList.add('visible');
            }

            function hidePreview() {
                hoverTimeout = setTimeout(() => {
                    preview.classList.remove('visible');
                    personPreview.classList.remove('visible');
                    photoPreview.classList.remove('visible');
                }, 50);
            }

            function positionPreview(e, previewEl, previewWidth, previewHeight) {
                const padding = 20;

                let x = e.clientX + padding;
                let y = e.clientY - previewHeight / 2;

                if (x + previewWidth > window.innerWidth - padding) {
                    x = e.clientX - previewWidth - padding;
                }

                if (y < padding) {
                    y = padding;
                } else if (y + previewHeight > window.innerHeight - padding) {
                    y = window.innerHeight - previewHeight - padding;
                }

                previewEl.style.left = x + 'px';
                previewEl.style.top = y + 'px';
            }

            document.getElementById('photo-grid').addEventListener('mouseenter', function(e) {
                if (e.target.tagName === 'IMG') {
                    if (isPhotoThumbnail(e.target)) {
                        showPreview(e);
                    } else if (isPersonThumbnail(e.target)) {
                        showPersonPreview(e);
                    }
                }
            }, true);

            document.getElementById('photo-grid').addEventListener('mouseleave', function(e) {
                if (e.target.tagName === 'IMG' && (isPhotoThumbnail(e.target) || isPersonThumbnail(e.target))) {
                    hidePreview();
                }
            }, true);

            document.getElementById('photo-grid').addEventListener('mousemove', function(e) {
                if (e.target.tagName === 'IMG') {
                    if (isPhotoThumbnail(e.target)) {
                        const isLandscape = photoPreview.classList.contains('landscape');
                        const sizes = getPreviewSizes(isLandscape);
                        if (photoPreview.classList.contains('visible')) {
                            positionPreview(e, photoPreview, sizes.detailWidth, sizes.detailHeight);
                        } else if (preview.classList.contains('visible')) {
                            positionPreview(e, preview, sizes.simple, sizes.simple);
                        }
                    } else if (isPersonThumbnail(e.target) && personPreview.classList.contains('visible')) {
                        positionPreview(e, personPreview, 160, 200);
                    }
                }
            }, true);
        })();

        // Face assignment functionality - allows assigning individual faces to persons
        let assignPhotoPath = null;
        let assignFaceId = null;  // Track which specific face to assign (null = all unassigned)
        let allPersons = [];

        async function showAssignFaceModal(photoPath) {
            assignPhotoPath = photoPath;
            assignFaceId = null;

            // Fetch faces in this photo to check if we need face selection
            try {
                const response = await fetch(`/api/photo/faces?path=${encodeURIComponent(photoPath)}`);
                const data = await response.json();
                const faces = data.faces || [];

                if (faces.length === 0) {
                    showToast(t('manage_persons.no_faces_in_photo'), true);
                    return;
                }

                if (faces.length === 1) {
                    // Single face - assign directly
                    assignFaceId = faces[0].id;
                    showSelectPersonModal();
                } else {
                    // Multiple faces - show face selection modal
                    showSelectFaceModal(faces);
                }
            } catch (err) {
                console.error('Error fetching faces:', err);
                showToast(t('manage_persons.error_loading_faces'), true);
            }
        }

        function showSelectFaceModal(faces) {
            const grid = document.getElementById('select-face-grid');
            grid.innerHTML = '';

            for (const face of faces) {
                const el = document.createElement('div');
                el.className = 'cursor-pointer bg-neutral-800 hover:bg-blue-600 rounded-lg p-2 text-center transition-colors';
                el.onclick = () => selectFaceForAssignment(face.id);

                const assignedInfo = face.person_name
                    ? `<div class="text-xs text-green-400 truncate">&rarr; ${face.person_name}</div>`
                    : `<div class="text-xs text-neutral-500">${t('manage_persons.unassigned')}</div>`;

                el.innerHTML = `
                    <img src="/face_thumbnail/${face.id}" class="w-full aspect-square rounded object-cover mb-2" loading="lazy">
                    <div class="text-xs text-neutral-300">${t('manage_persons.face_number', {index: face.face_index + 1})}</div>
                    ${assignedInfo}
                `;
                grid.appendChild(el);
            }

            document.getElementById('select-face-modal').classList.remove('hidden');
        }

        function selectFaceForAssignment(faceId) {
            assignFaceId = faceId;
            closeSelectFaceModal();
            showSelectPersonModal();
        }

        function closeSelectFaceModal() {
            document.getElementById('select-face-modal').classList.add('hidden');
        }

        async function showSelectPersonModal() {
            const grid = document.getElementById('select-person-grid');
            grid.innerHTML = `<div class="col-span-6 text-center text-neutral-500">${t('ui.labels.loading')}</div>`;
            document.getElementById('select-person-modal').classList.remove('hidden');

            try {
                const response = await fetch('/api/filter_options/persons');
                const data = await response.json();
                // Only show named persons (filter out auto-clustered "Person 123")
                allPersons = (data.persons || []).filter(([id, name]) => name);
                renderPersonGrid(allPersons);
            } catch (err) {
                grid.innerHTML = `<div class="col-span-6 text-center text-red-500">${t('manage_persons.error_loading_persons')}</div>`;
            }
        }

        function renderPersonGrid(persons) {
            const grid = document.getElementById('select-person-grid');
            grid.innerHTML = '';
            for (const [id, name, count] of persons) {
                const el = document.createElement('div');
                el.className = 'cursor-pointer bg-neutral-800 hover:bg-blue-600 rounded-lg p-2 text-center transition-colors';
                el.onclick = () => assignAllFacesToPerson(id);
                el.innerHTML = `
                    <img src="/person_thumbnail/${id}" class="w-full aspect-square rounded-full object-cover mb-2" loading="lazy">
                    <div class="text-xs text-neutral-300 truncate">${name}</div>
                    <div class="text-xs text-neutral-500">${t('manage_persons.photos_count', {count})}</div>
                `;
                grid.appendChild(el);
            }
            if (persons.length === 0) {
                grid.innerHTML = `<div class="col-span-6 text-center text-neutral-500">${t('manage_persons.no_named_persons')}</div>`;
            }
        }

        document.getElementById('person-search').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const filtered = allPersons.filter(([id, name]) =>
                (name || t('manage_persons.person_fallback', {id})).toLowerCase().includes(query)
            );
            renderPersonGrid(filtered);
        });

        function closeSelectPersonModal() {
            document.getElementById('select-person-modal').classList.add('hidden');
            document.getElementById('person-search').value = '';
            assignPhotoPath = null;
        }

        // Similar photos modal functions
        async function showSimilarPhotosModal(photoPath) {
            const modal = document.getElementById('similar-photos-modal');
            const grid = document.getElementById('similar-photos-grid');
            const loading = document.getElementById('similar-photos-loading');
            const empty = document.getElementById('similar-photos-empty');

            modal.classList.remove('hidden');
            grid.innerHTML = '';
            loading.classList.remove('hidden');
            empty.classList.add('hidden');

            try {
                const response = await fetch(`/api/similar_photos/${encodeURIComponent(photoPath)}?limit=20`);
                const data = await response.json();

                loading.classList.add('hidden');

                if (data.error) {
                    empty.textContent = data.error;
                    empty.classList.remove('hidden');
                    return;
                }

                if (!data.similar || data.similar.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }

                // Render similar photos
                data.similar.forEach(photo => {
                    const simPercent = Math.round(photo.similarity * 100);
                    const breakdown = photo.breakdown || {};

                    // Build breakdown tooltip
                    let breakdownText = [];
                    if (breakdown.clip !== undefined) breakdownText.push(`${t('similar.visual')}: ${Math.round(breakdown.clip * 100)}%`);
                    if (breakdown.persons !== undefined) breakdownText.push(`${t('similar.persons')}: ${Math.round(breakdown.persons * 100)}%`);
                    if (breakdown.date !== undefined) breakdownText.push(`${t('similar.date')}: ${Math.round(breakdown.date * 100)}%`);
                    if (breakdown.score !== undefined) breakdownText.push(`${t('similar.score')}: ${Math.round(breakdown.score * 100)}%`);

                    const card = document.createElement('div');
                    card.className = 'similar-photo-card cursor-pointer hover:ring-2 hover:ring-purple-500 rounded-lg overflow-hidden bg-neutral-800';
                    card.title = breakdownText.join('\\n');
                    const filename = photo.filename;
                    card.innerHTML = `
                        <div class="relative w-full aspect-square">
                            <img src="/thumbnail?path=${encodeURIComponent(photo.path)}&size=320" class="absolute inset-0 w-full h-full object-cover" loading="lazy">
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-2">
                                <div class="text-white text-sm font-medium">${simPercent}% ${t('similar.similarity')}</div>
                                <div class="text-neutral-300 text-xs">${safeFloat(photo.aggregate, 1)} score</div>
                            </div>
                        </div>
                        <div class="p-2">
                            <div class="text-xs text-neutral-400 truncate" title="${filename}">${filename}</div>
                        </div>
                    `;
                    card.onclick = () => {
                        closeSimilarPhotosModal();
                        // Navigate to photo - find card and scroll to it, or search by filename with filters reset
                        const photoCard = document.querySelector(`.photo-card[data-path="${encodeURIComponent(photo.path)}"]`);
                        if (photoCard) {
                            photoCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            photoCard.classList.add('ring-2', 'ring-purple-500');
                            setTimeout(() => photoCard.classList.remove('ring-2', 'ring-purple-500'), 2000);
                        } else {
                            // Photo not on current page - search by filename with all filters reset
                            window.location.href = `/?search=${encodeURIComponent(filename)}&type=&hide_blinks=0&hide_bursts=0&hide_duplicates=0&hide_rejected=0`;
                        }
                    };
                    grid.appendChild(card);
                });
            } catch (err) {
                loading.classList.add('hidden');
                empty.textContent = err.message;
                empty.classList.remove('hidden');
            }
        }

        function closeSimilarPhotosModal() {
            document.getElementById('similar-photos-modal').classList.add('hidden');
        }

        async function assignAllFacesToPerson(personId) {
            if (!assignPhotoPath) return;

            try {
                let response, data;

                if (assignFaceId) {
                    // Assign specific face
                    response = await fetch(`/api/face/${assignFaceId}/assign`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ person_id: personId })
                    });
                } else {
                    // Assign all unassigned faces
                    response = await fetch('/api/photo/assign_all_faces', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ photo_path: assignPhotoPath, person_id: personId })
                    });
                }

                data = await response.json();

                if (data.success) {
                    closeSelectPersonModal();
                    showToast(t('notifications.faces_assigned'));
                } else {
                    showToast(t('manage_persons.error_assigning_faces') + ': ' + (data.error || ''), true);
                }
            } catch (err) {
                showToast(t('manage_persons.error_assigning_faces') + ': ' + err.message, true);
            }
        }

        async function removePersonFromPhoto(photoPath, personId) {
            if (!confirm(t('manage_persons.confirm_remove_person'))) return;
            try {
                const response = await fetch('/api/photo/unassign_person', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify({ photo_path: photoPath, person_id: personId })
                });
                const data = await response.json();
                if (response.ok) {
                    // Remove the photo card from view
                    const card = document.querySelector(`[data-path="${CSS.escape(encodeURIComponent(photoPath))}"]`);
                    if (card) card.remove();
                } else {
                    showToast(data.error || '', true);
                }
            } catch (err) {
                showToast(err.message, true);
            }
        }

        // Close modals on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSelectPersonModal();
                closeSimilarPhotosModal();
                if (typeof closeEditionLoginModal === 'function') closeEditionLoginModal();
            }
        });

        // Close modals on backdrop click
        document.getElementById('select-person-modal').addEventListener('click', function(e) {
            if (e.target.id === 'select-person-modal') closeSelectPersonModal();
        });

        // Edition login modal backdrop click
        const editionModal = document.getElementById('edition-login-modal');
        if (editionModal) {
            editionModal.addEventListener('click', function(e) {
                if (e.target.id === 'edition-login-modal') closeEditionLoginModal();
            });
        }

        // Rating functions (edition mode)
        async function setRating(photoPath, rating, starContainer) {
            try {
                const response = await fetch('/api/photo/set_rating', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify({ photo_path: photoPath, rating: rating })
                });
                const data = await response.json();
                if (data.success) {
                    // Update star display
                    const stars = starContainer.querySelectorAll('.star-btn');
                    stars.forEach((star, i) => {
                        if (i < rating) {
                            star.classList.add('text-yellow-400');
                            star.classList.remove('text-neutral-500');
                        } else {
                            star.classList.remove('text-yellow-400');
                            star.classList.add('text-neutral-500');
                        }
                    });
                    starContainer.dataset.current = rating;
                    // Update rating badge (check if favorited first - heart takes priority)
                    const favoriteBtn = starContainer.closest('.rating-controls')?.querySelector('[data-favorite]');
                    const isFavorite = favoriteBtn?.dataset.favorite === '1';
                    updateRatingBadge(photoPath, rating, isFavorite);
                    showToast(t('rating.set_rating') + ': ' + rating + ' ★');
                } else {
                    showToast(data.error || '', true);
                }
            } catch (err) {
                showToast(err.message, true);
            }
        }

        async function toggleFavorite(photoPath, btn) {
            try {
                const response = await fetch('/api/photo/toggle_favorite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify({ photo_path: photoPath })
                });
                const data = await response.json();
                if (data.success) {
                    if (data.is_favorite) {
                        btn.classList.add('text-red-400');
                        btn.classList.remove('text-neutral-500');
                        btn.dataset.favorite = '1';
                        // When marking favorite, also clear rejected (mutually exclusive)
                        const rejectedBtn = btn.closest('.rating-controls')?.querySelector('.rejected-btn');
                        if (rejectedBtn) {
                            rejectedBtn.classList.remove('text-red-600');
                            rejectedBtn.classList.add('text-neutral-500');
                            rejectedBtn.dataset.rejected = '0';
                        }
                    } else {
                        btn.classList.remove('text-red-400');
                        btn.classList.add('text-neutral-500');
                        btn.dataset.favorite = '0';
                    }
                    // Update rating badge (get current star rating to show if not favorite)
                    const starContainer = btn.closest('.rating-controls')?.querySelector('.star-rating');
                    const starRating = parseInt(starContainer?.dataset.current || '0', 10);
                    updateRatingBadge(photoPath, starRating, data.is_favorite);
                    showToast(data.is_favorite ? t('rating.add_favorite') : t('rating.remove_favorite'));
                } else {
                    showToast(data.error || '', true);
                }
            } catch (err) {
                showToast(err.message, true);
            }
        }

        async function toggleRejected(photoPath, btn) {
            try {
                const response = await fetch('/api/photo/toggle_rejected', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify({ photo_path: photoPath })
                });
                const data = await response.json();
                if (data.success) {
                    if (data.is_rejected) {
                        btn.classList.add('text-red-600');
                        btn.classList.remove('text-neutral-500');
                        btn.dataset.rejected = '1';
                        // When rejecting, also reset star rating to 0 and clear favorite
                        const starContainer = btn.closest('.rating-controls').querySelector('.star-rating');
                        if (starContainer) {
                            starContainer.dataset.current = '0';
                            starContainer.querySelectorAll('.star-btn').forEach(s => {
                                s.classList.remove('text-yellow-400');
                                s.classList.add('text-neutral-500');
                            });
                        }
                        // Clear favorite (mutually exclusive)
                        const favoriteBtn = btn.closest('.rating-controls')?.querySelector('.favorite-btn');
                        if (favoriteBtn) {
                            favoriteBtn.classList.remove('text-red-400');
                            favoriteBtn.classList.add('text-neutral-500');
                            favoriteBtn.dataset.favorite = '0';
                        }
                        // Update rating badge (remove)
                        updateRatingBadge(photoPath, 0, false);
                    } else {
                        btn.classList.remove('text-red-600');
                        btn.classList.add('text-neutral-500');
                        btn.dataset.rejected = '0';
                    }
                    showToast(data.is_rejected ? t('rating.mark_rejected') : t('rating.unmark_rejected'));
                } else {
                    showToast(data.error || '', true);
                }
            } catch (err) {
                showToast(err.message, true);
            }
        }

        // Helper function to update rating badge on photo thumbnail
        function updateRatingBadge(photoPath, starRating, isFavorite) {
            const escapedPath = photoPath.replace(/'/g, "\\'");
            const badge = document.querySelector(`.rating-badge[data-path="${escapedPath}"]`);
            const container = document.querySelector(`.photo-thumb-container[onclick*="${escapedPath}"]`) ||
                             document.querySelector(`[data-path="${encodeURIComponent(photoPath)}"] .photo-thumb-container`);

            if (isFavorite) {
                // Show heart
                if (badge) {
                    badge.innerHTML = '<span class="text-red-400">❤</span>';
                } else if (container) {
                    const newBadge = document.createElement('div');
                    newBadge.className = 'rating-badge absolute top-8 right-1 bg-black/70 rounded px-1 py-0.5 text-xs font-medium z-10';
                    newBadge.dataset.path = photoPath;
                    newBadge.innerHTML = '<span class="text-red-400">❤</span>';
                    container.appendChild(newBadge);
                }
            } else if (starRating > 0) {
                // Show star count
                if (badge) {
                    badge.innerHTML = `<span class="text-yellow-400">★${starRating}</span>`;
                } else if (container) {
                    const newBadge = document.createElement('div');
                    newBadge.className = 'rating-badge absolute top-8 right-1 bg-black/70 rounded px-1 py-0.5 text-xs font-medium z-10';
                    newBadge.dataset.path = photoPath;
                    newBadge.innerHTML = `<span class="text-yellow-400">★${starRating}</span>`;
                    container.appendChild(newBadge);
                }
            } else {
                // Remove badge
                if (badge) {
                    badge.remove();
                }
            }
        }
    </script>
</body>
</html>
