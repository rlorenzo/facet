<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ _('manage_persons.title') }} - Facet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .person-card { transition: all 0.2s; }
        .person-card.selected { border-color: #3b82f6; box-shadow: 0 0 0 2px #3b82f6; }
        .person-card:hover:not(.selected) { border-color: #525252; }
        .person-card .delete-btn, .person-card .avatar-btn { opacity: 0; }
        .person-card:hover .delete-btn, .person-card:hover .avatar-btn { opacity: 1; }
    </style>
</head>
<body class="bg-neutral-950 text-white min-h-screen">
    <header class="bg-neutral-900 border-b border-neutral-800 px-6 py-3 sticky top-0 z-40">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/" class="text-neutral-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                </a>
                <h1 class="text-xl font-semibold">{{ _('manage_persons.title') }}</h1>
                <select onchange="window.location='?sort=' + this.value" class="bg-neutral-800 text-white text-sm px-2 py-1.5 rounded border border-neutral-700 focus:border-green-500 focus:outline-none">
                    <option value="count_desc" {% if sort_by == 'count_desc' %}selected{% endif %}>{{ _('manage_persons.sort.count_desc') }}</option>
                    <option value="count_asc" {% if sort_by == 'count_asc' %}selected{% endif %}>{{ _('manage_persons.sort.count_asc') }}</option>
                    <option value="quality_asc" {% if sort_by == 'quality_asc' %}selected{% endif %}>{{ _('manage_persons.sort.quality_asc') }}</option>
                    <option value="quality_desc" {% if sort_by == 'quality_desc' %}selected{% endif %}>{{ _('manage_persons.sort.quality_desc') }}</option>
                </select>
                {% if edition_authenticated and viewer_config.features.show_merge_suggestions %}
                <a href="/suggest_merges" class="text-sm text-neutral-400 hover:text-white px-3 py-1.5 bg-neutral-800 rounded border border-neutral-700 hover:border-neutral-600 transition-colors">
                    {{ _('manage_persons.suggest_merges') }}
                </a>
                {% endif %}
            </div>
            {% if edition_authenticated %}
            <div class="flex items-center gap-3">
                <div id="selection-status" class="text-sm text-neutral-500"></div>
                <button id="clear-btn" onclick="clearSelection()" class="hidden px-3 py-1.5 bg-neutral-700 hover:bg-neutral-600 text-white text-sm rounded transition-colors">
                    {{ _('ui.buttons.clear') }}
                </button>
                <button id="delete-btn" onclick="deleteSelected()" class="hidden px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white text-sm rounded font-medium transition-colors">
                    {{ _('ui.buttons.delete') }}
                </button>
                <button id="merge-btn" onclick="startMerge()" class="hidden px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded font-medium transition-colors">
                    {{ _('ui.buttons.merge') }}
                </button>
            </div>
            {% endif %}
        </div>
    </header>

    <main class="p-6">
        <!-- Persons Grid -->
        <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 xl:grid-cols-12 gap-3">
            {% for person in persons %}
            <div class="person-card group relative bg-neutral-900 border border-neutral-800 rounded-lg p-2 {% if edition_authenticated %}cursor-pointer{% endif %} text-center"
                 data-id="{{ person.id }}"
                 data-name="{{ person.name or 'Person ' ~ person.id }}"
                 data-count="{{ person.face_count }}"
                 {% if edition_authenticated %}onclick="toggleSelection(this)"{% endif %}>
                {% if edition_authenticated %}
                <button onclick="event.stopPropagation(); deletePerson({{ person.id }}, '{{ (person.name or 'Person ' ~ person.id)|e }}', {{ person.face_count }})"
                        class="delete-btn absolute -top-1 -right-1 w-5 h-5 bg-red-600 hover:bg-red-500 rounded-full flex items-center justify-center text-white transition-opacity z-10"
                        title="Delete person">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <button onclick="event.stopPropagation(); showFacesModal({{ person.id }}, '{{ (person.name or 'Person ' ~ person.id)|e }}')"
                        class="avatar-btn absolute -top-1 -left-1 w-5 h-5 bg-green-600 hover:bg-green-500 rounded-full flex items-center justify-center text-white transition-opacity z-10"
                        title="{{ _('manage_persons.change_avatar') }}">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </button>
                {% endif %}
                <img src="/person_thumbnail/{{ person.id }}"
                     class="w-full aspect-square rounded-full object-cover mb-2"
                     loading="lazy" alt="">
                <div class="text-xs text-neutral-300 truncate">{{ person.name or 'Person ' ~ person.id }}</div>
                <div class="text-xs text-neutral-500 mb-1">{{ person.face_count }} photos</div>
                <div class="flex gap-1 justify-center">
                    <a href="/?person={{ person.id }}"
                       onclick="event.stopPropagation()"
                       class="text-[10px] px-2 py-0.5 bg-neutral-700 hover:bg-green-600 text-neutral-300 hover:text-white rounded transition-colors">
                        {{ _('ui.buttons.view') }}
                    </a>
                    {% if edition_authenticated %}
                    <button onclick="event.stopPropagation(); renamePerson({{ person.id }}, '{{ (person.name or 'Person ' ~ person.id)|e }}')"
                            class="text-[10px] px-2 py-0.5 bg-neutral-700 hover:bg-yellow-600 text-neutral-300 hover:text-white rounded transition-colors"
                            title="{{ _('ui.buttons.rename') }}">
                        <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </button>
                    {% endif %}
                    <button onclick="event.stopPropagation(); copyPersonUrl({{ person.id }})"
                            class="text-[10px] px-2 py-0.5 bg-neutral-700 hover:bg-blue-600 text-neutral-300 hover:text-white rounded transition-colors"
                            title="{{ _('ui.buttons.share') }}">
                        <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                        </svg>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>

    <!-- Copy Notification -->
    <div id="copy-notification" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="copy-notification-text">Copied!</span>
    </div>

    <!-- Target Selection Modal -->
    <div id="target-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-neutral-900 rounded-lg p-6 max-w-lg w-full mx-4 border border-neutral-700">
            <h3 class="text-lg font-semibold mb-2">{{ _('manage_persons.select_target') }}</h3>
            <p class="text-neutral-400 text-sm mb-4">{{ _('manage_persons.merge_explanation') }}</p>
            <div id="target-options" class="grid grid-cols-4 gap-3 mb-4 max-h-64 overflow-y-auto">
                <!-- Dynamically populated with selected persons -->
            </div>
            <button onclick="closeModal()" class="w-full bg-neutral-700 hover:bg-neutral-600 py-2 rounded transition-colors">
                {{ _('ui.buttons.cancel') }}
            </button>
        </div>
    </div>

    <!-- Faces Modal for Avatar Selection -->
    <div id="faces-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-neutral-900 rounded-lg p-6 max-w-2xl w-full mx-4 border border-neutral-700">
            <h3 class="text-lg font-semibold mb-2">{{ _('manage_persons.select_avatar') }}</h3>
            <p id="faces-modal-person-name" class="text-neutral-400 text-sm mb-4"></p>
            <div id="faces-grid" class="grid grid-cols-6 gap-2 mb-4 max-h-80 overflow-y-auto">
                <!-- Dynamically populated with faces -->
            </div>
            <button onclick="closeFacesModal()" class="w-full bg-neutral-700 hover:bg-neutral-600 py-2 rounded transition-colors">
                {{ _('ui.buttons.cancel') }}
            </button>
        </div>
    </div>

    <script>
        // i18n translations
        const I18N = {{ js_translations(['manage_persons', 'notifications', 'ui', 'similar', 'rating']) | tojson | safe }};
        function t(key, vars={}) {
            const keys = key.split('.');
            let value = I18N;
            for (const k of keys) {
                if (value && typeof value === 'object' && k in value) {
                    value = value[k];
                } else {
                    return key;
                }
            }
            if (typeof value === 'string' && Object.keys(vars).length > 0) {
                return value.replace(/\{(\w+)\}/g, (m, k) => vars[k] !== undefined ? vars[k] : m);
            }
            return value || key;
        }

        // Multi-select using a Set of selected IDs
        let selectedIds = new Set();

        function toggleSelection(el) {
            const id = parseInt(el.dataset.id);

            if (selectedIds.has(id)) {
                selectedIds.delete(id);
                el.classList.remove('selected');
            } else {
                selectedIds.add(id);
                el.classList.add('selected');
            }
            updateUI();
        }

        function updateUI() {
            const count = selectedIds.size;
            const mergeBtn = document.getElementById('merge-btn');
            const clearBtn = document.getElementById('clear-btn');
            const deleteBtn = document.getElementById('delete-btn');
            const statusEl = document.getElementById('selection-status');

            if (count === 0) {
                mergeBtn.classList.add('hidden');
                deleteBtn.classList.add('hidden');
                clearBtn.classList.add('hidden');
                statusEl.textContent = '';
            } else if (count === 1) {
                mergeBtn.classList.add('hidden');
                deleteBtn.classList.remove('hidden');
                clearBtn.classList.remove('hidden');
                statusEl.textContent = `1 ${t('ui.labels.selected')}`;
                statusEl.classList.remove('text-blue-400');
                statusEl.classList.add('text-neutral-400');
            } else {
                mergeBtn.classList.remove('hidden');
                deleteBtn.classList.remove('hidden');
                clearBtn.classList.remove('hidden');
                statusEl.textContent = `${count} ${t('ui.labels.selected')}`;
                statusEl.classList.remove('text-neutral-400');
                statusEl.classList.add('text-blue-400');
            }
        }

        function clearSelection() {
            document.querySelectorAll('.person-card').forEach(el => {
                el.classList.remove('selected');
            });
            selectedIds.clear();
            updateUI();
        }

        function showNotification(message) {
            const notification = document.getElementById('copy-notification');
            const text = document.getElementById('copy-notification-text');
            text.textContent = message;

            notification.classList.remove('translate-y-20', 'opacity-0');
            notification.classList.add('translate-y-0', 'opacity-100');

            setTimeout(() => {
                notification.classList.remove('translate-y-0', 'opacity-100');
                notification.classList.add('translate-y-20', 'opacity-0');
            }, 2000);
        }

        async function copyPersonUrl(personId) {
            try {
                const response = await fetch(`/api/person/${personId}/share-token`);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                const data = await response.json();
                const url = `${window.location.origin}/person/${personId}?token=${data.token}`;

                // Try modern clipboard API first, fall back to execCommand
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(url);
                } else {
                    // Fallback for non-secure contexts (HTTP)
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }
                showNotification(t('notifications.link_copied') || 'Link copied to clipboard');
            } catch (err) {
                console.error('Failed to generate share URL:', err);
                showNotification(t('notifications.copy_failed') || 'Failed to copy link');
            }
        }

        function startMerge() {
            if (selectedIds.size < 2) return;

            // Populate the modal with selected persons
            const optionsContainer = document.getElementById('target-options');
            optionsContainer.innerHTML = '';

            selectedIds.forEach(id => {
                const card = document.querySelector(`[data-id="${id}"]`);
                const name = card.dataset.name;
                const count = card.dataset.count;

                const option = document.createElement('div');
                option.className = 'cursor-pointer bg-neutral-800 hover:bg-blue-600 rounded-lg p-2 text-center transition-colors';
                option.onclick = () => executeBatchMerge(id);
                option.innerHTML = `
                    <img src="/person_thumbnail/${id}" class="w-full aspect-square rounded-full object-cover mb-2">
                    <div class="text-xs text-neutral-300 truncate">${name}</div>
                    <div class="text-xs text-neutral-500">${count} photos</div>
                `;
                optionsContainer.appendChild(option);
            });

            document.getElementById('target-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('target-modal').classList.add('hidden');
        }

        async function executeBatchMerge(targetId) {
            const sourceIds = Array.from(selectedIds).filter(id => id !== targetId);

            if (sourceIds.length === 0) {
                alert('Cannot merge a person into itself');
                return;
            }

            try {
                const response = await fetch('/merge_persons_batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ source_ids: sourceIds, target_id: targetId })
                });
                const data = await response.json();

                if (data.success) {
                    closeModal();
                    // Remove merged person cards from DOM
                    sourceIds.forEach(id => {
                        const card = document.querySelector(`[data-id="${id}"]`);
                        if (card) card.remove();
                    });
                    // Update target card's count
                    const targetCard = document.querySelector(`[data-id="${targetId}"]`);
                    if (targetCard && data.new_count !== undefined) {
                        targetCard.dataset.count = data.new_count;
                        targetCard.querySelector('.text-neutral-500').textContent = data.new_count + ' photos';
                    }
                    // Clear selection
                    clearSelection();
                } else {
                    alert(t('notifications.error_merging') + ': ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert(t('notifications.error_merging') + ': ' + err.message);
            }
        }

        async function deletePerson(personId, personName, photoCount) {
            try {
                const response = await fetch(`/delete_person/${personId}`, {
                    method: 'POST',
                    headers: {'X-Requested-With': 'XMLHttpRequest'}
                });
                const data = await response.json();

                if (data.success) {
                    const card = document.querySelector(`[data-id="${personId}"]`);
                    if (card) card.remove();
                    selectedIds.delete(personId);
                    updateUI();
                } else {
                    alert(t('notifications.error_deleting') + ': ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert(t('notifications.error_deleting') + ': ' + err.message);
            }
        }

        function renamePerson(personId, currentName) {
            const newName = prompt(t('manage_persons.enter_new_name'), currentName);
            if (newName !== null && newName.trim() !== currentName) {
                const formData = new FormData();
                formData.append('name', newName.trim());
                fetch('/rename_person/' + personId, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update card name without reload
                        const card = document.querySelector(`[data-id="${personId}"]`);
                        if (card) {
                            card.dataset.name = data.name;
                            card.querySelector('.text-neutral-300').textContent = data.name;
                        }
                    } else {
                        alert(t('notifications.failed_rename'));
                    }
                })
                .catch(() => alert(t('notifications.failed_rename')));
            }
        }

        async function deleteSelected() {
            const idsToDelete = Array.from(selectedIds);
            if (idsToDelete.length === 0) return;

            try {
                const response = await fetch('/delete_persons_batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ person_ids: idsToDelete })
                });
                const data = await response.json();

                if (data.success) {
                    idsToDelete.forEach(personId => {
                        const card = document.querySelector(`[data-id="${personId}"]`);
                        if (card) card.remove();
                    });
                    selectedIds.clear();
                    updateUI();
                } else {
                    alert(t('notifications.error_deleting') + ': ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert(t('notifications.error_deleting') + ': ' + err.message);
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeFacesModal();
            }
        });

        // Close modal on backdrop click
        document.getElementById('target-modal').addEventListener('click', (e) => {
            if (e.target.id === 'target-modal') closeModal();
        });

        document.getElementById('faces-modal').addEventListener('click', (e) => {
            if (e.target.id === 'faces-modal') closeFacesModal();
        });

        // Avatar selection
        let currentPersonIdForAvatar = null;

        async function showFacesModal(personId, personName) {
            currentPersonIdForAvatar = personId;
            document.getElementById('faces-modal-person-name').textContent = personName;

            const grid = document.getElementById('faces-grid');
            grid.innerHTML = '<div class="col-span-6 text-center text-neutral-500">Loading...</div>';

            document.getElementById('faces-modal').classList.remove('hidden');

            try {
                const response = await fetch(`/api/person/${personId}/faces`);
                const data = await response.json();

                grid.innerHTML = '';
                for (const face of data.faces) {
                    const el = document.createElement('div');
                    el.className = 'cursor-pointer rounded-lg overflow-hidden hover:ring-2 hover:ring-green-500 transition-all';
                    el.onclick = () => selectAvatar(face.id);
                    el.innerHTML = `<img src="/face_thumbnail/${face.id}" class="w-full aspect-square object-cover" loading="lazy">`;
                    grid.appendChild(el);
                }

                if (data.faces.length === 0) {
                    grid.innerHTML = '<div class="col-span-6 text-center text-neutral-500">No faces found</div>';
                }
            } catch (err) {
                grid.innerHTML = '<div class="col-span-6 text-center text-red-500">Error loading faces</div>';
            }
        }

        function closeFacesModal() {
            document.getElementById('faces-modal').classList.add('hidden');
            currentPersonIdForAvatar = null;
        }

        async function selectAvatar(faceId) {
            if (!currentPersonIdForAvatar) return;

            try {
                const response = await fetch(`/api/person/${currentPersonIdForAvatar}/avatar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ face_id: faceId })
                });
                const data = await response.json();

                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error setting avatar: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error setting avatar: ' + err.message);
            }
        }
    </script>
</body>
</html>
